<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ— - {{ TITLE }}</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }
        
        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            min-width: 200px;
        }
        
        #controls button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        #controls button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        #controls button:active {
            transform: translateY(0);
        }
        
        #controls input[type="color"] {
            width: 40px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        #mindmap {
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle, #ffffff 0%, #f8f9fa 100%);
        }
        
        .node circle {
            fill: #4CAF50;
            stroke: #2E7D32;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .node circle:hover {
            fill: #66BB6A;
            stroke-width: 3px;
            r: 25;
        }
        
        .node text {
            font-family: inherit;
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
            user-select: none;
        }
        
        .link {
            fill: none;
            stroke: #8BC34A;
            stroke-width: 2px;
            transition: all 0.3s ease;
        }
        
        .link:hover {
            stroke: #4CAF50;
            stroke-width: 3px;
        }
        
        .node.collapsed circle {
            fill: #FFC107;
            stroke: #FF8F00;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        /* Loading spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ -->
    <div id="controls">
        <button onclick="zoomIn()" title="ã‚ºãƒ¼ãƒ ã‚¤ãƒ³">ğŸ”+</button>
        <button onclick="zoomOut()" title="ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ">ğŸ”-</button>
        <button onclick="resetZoom()" title="ãƒªã‚»ãƒƒãƒˆ">âŸ²</button>
        <button onclick="toggleOrientation()" title="ç¸¦æ¨ªåˆ‡æ›¿">â¬Œ</button>
        <button onclick="expandAll()" title="å…¨å±•é–‹">ğŸ“‚</button>
        <button onclick="collapseAll()" title="å…¨æŠ˜ã‚ŠãŸãŸã¿">ğŸ“</button>
        <input type="color" value="#4CAF50" onchange="changeColor(this.value)" title="è‰²å¤‰æ›´">
        <button onclick="fitToScreen()" title="ç”»é¢ã«åˆã‚ã›ã‚‹">ğŸ“</button>
    </div>
    
    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
    <div id="tooltip" class="tooltip"></div>
    
    <!-- SVGã‚³ãƒ³ãƒ†ãƒŠ -->
    <svg id="mindmap"></svg>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div id="loading" class="loading">ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let svg, g, tree, root, zoom, tooltip;
        let currentColor = "#4CAF50";
        let isVertical = true;
        let width = window.innerWidth;
        let height = window.innerHeight;
        
        // ãƒ‡ãƒ¼ã‚¿è¨­å®šï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã§ç½®æ›ã•ã‚Œã‚‹ï¼‰
        const data = {{ JSON_DATA }};
        
        // åˆæœŸåŒ–
        function init() {
            // SVGè¦ç´ ã®è¨­å®š
            svg = d3.select("#mindmap")
                .attr("width", width)
                .attr("height", height);
            
            // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ã®è¨­å®š
            zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            
            svg.call(zoom);
            
            // ãƒ¡ã‚¤ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
            g = svg.append("g");
            
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®è¨­å®š
            tooltip = d3.select("#tooltip");
            
            // ãƒ„ãƒªãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è¨­å®š
            tree = d3.tree().size([width - 200, height - 200]);
            
            // ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã¨æç”»
            if (data) {
                root = d3.hierarchy(data);
                root.x0 = width / 2;
                root.y0 = height / 2;
                
                // åˆæœŸçŠ¶æ…‹ã§ã¯ä¸€éƒ¨ã‚’æŠ˜ã‚ŠãŸãŸã¿
                if (root.children) {
                    root.children.forEach(collapse);
                }
                
                update(root);
                hideLoading();
            } else {
                showError("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            }
        }
        
        // ãƒãƒ¼ãƒ‰ã®æ›´æ–°
        function update(source) {
            // ãƒ„ãƒªãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è¨ˆç®—
            const treeData = tree(root);
            const nodes = treeData.descendants();
            const links = treeData.descendants().slice(1);
            
            // ãƒãƒ¼ãƒ‰ã®ä½ç½®èª¿æ•´ï¼ˆç¸¦æ¨ªåˆ‡ã‚Šæ›¿ãˆå¯¾å¿œï¼‰
            if (!isVertical) {
                nodes.forEach(d => {
                    const temp = d.x;
                    d.x = d.y;
                    d.y = temp;
                });
            }
            
            // ãƒãƒ¼ãƒ‰ã®æç”»
            const node = g.selectAll('.node')
                .data(nodes, d => d.id || (d.id = ++nodeId));
            
            // æ–°ã—ã„ãƒãƒ¼ãƒ‰ã®è¿½åŠ 
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${source.x0 || 0},${source.y0 || 0})`)
                .on('click', click)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);
            
            // å††ã®è¿½åŠ 
            nodeEnter.append('circle')
                .attr('r', 1e-6)
                .style('fill', d => d._children ? "#FFC107" : currentColor)
                .style('stroke', d => d._children ? "#FF8F00" : d3.rgb(currentColor).darker());
            
            // ãƒ†ã‚­ã‚¹ãƒˆã®è¿½åŠ 
            nodeEnter.append('text')
                .attr('dy', '.35em')
                .attr('text-anchor', 'middle')
                .text(d => d.data.name)
                .style('fill-opacity', 1e-6);
            
            // ãƒãƒ¼ãƒ‰ã®æ›´æ–°
            const nodeUpdate = nodeEnter.merge(node);
            
            // ä½ç½®ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã®æ›´æ–°
            nodeUpdate.transition()
                .duration(750)
                .attr('transform', d => `translate(${d.x},${d.y})`);
            
            nodeUpdate.select('circle')
                .transition()
                .duration(750)
                .attr('r', 20)
                .style('fill', d => d._children ? "#FFC107" : currentColor)
                .style('stroke', d => d._children ? "#FF8F00" : d3.rgb(currentColor).darker());
            
            nodeUpdate.select('text')
                .transition()
                .duration(750)
                .style('fill-opacity', 1);
            
            // ä¸è¦ãªãƒãƒ¼ãƒ‰ã®å‰Šé™¤
            const nodeExit = node.exit().transition()
                .duration(750)
                .attr('transform', d => `translate(${source.x},${source.y})`)
                .remove();
            
            nodeExit.select('circle')
                .attr('r', 1e-6);
            
            nodeExit.select('text')
                .style('fill-opacity', 1e-6);
            
            // ãƒªãƒ³ã‚¯ã®æç”»
            const link = g.selectAll('.link')
                .data(links, d => d.id);
            
            // æ–°ã—ã„ãƒªãƒ³ã‚¯ã®è¿½åŠ 
            const linkEnter = link.enter().insert('path', 'g')
                .attr('class', 'link')
                .attr('d', d => {
                    const o = {x: source.x0 || 0, y: source.y0 || 0};
                    return diagonal(o, o);
                });
            
            // ãƒªãƒ³ã‚¯ã®æ›´æ–°
            const linkUpdate = linkEnter.merge(link);
            
            linkUpdate.transition()
                .duration(750)
                .attr('d', d => diagonal(d, d.parent));
            
            // ä¸è¦ãªãƒªãƒ³ã‚¯ã®å‰Šé™¤
            const linkExit = link.exit().transition()
                .duration(750)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();
            
            // å‰å›ã®ä½ç½®ã‚’ä¿å­˜
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }
        
        // å¯¾è§’ç·šï¼ˆãƒ™ã‚¸ã‚§æ›²ç·šï¼‰ã®è¨ˆç®—
        function diagonal(s, d) {
            const path = `M ${s.x} ${s.y}
                         C ${s.x} ${(s.y + d.y) / 2},
                           ${d.x} ${(s.y + d.y) / 2},
                           ${d.x} ${d.y}`;
            return path;
        }
        
        // ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            update(d);
        }
        
        // ãƒãƒ¼ãƒ‰æŠ˜ã‚ŠãŸãŸã¿
        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }
        
        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
        function showTooltip(event, d) {
            tooltip.style("opacity", 1)
                .html(`<strong>${d.data.name}</strong><br>ãƒ¬ãƒ™ãƒ«: ${d.depth}<br>å­ãƒãƒ¼ãƒ‰: ${d.children ? d.children.length : d._children ? d._children.length : 0}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }
        
        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—éè¡¨ç¤º
        function hideTooltip() {
            tooltip.style("opacity", 0);
        }
        
        // ã‚ºãƒ¼ãƒ ã‚¤ãƒ³
        function zoomIn() {
            svg.transition().call(
                zoom.scaleBy, 1.2
            );
        }
        
        // ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ
        function zoomOut() {
            svg.transition().call(
                zoom.scaleBy, 0.8
            );
        }
        
        // ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetZoom() {
            svg.transition().call(
                zoom.transform,
                d3.zoomIdentity.translate(width / 2, height / 2).scale(1)
            );
        }
        
        // ç”»é¢ã«åˆã‚ã›ã‚‹
        function fitToScreen() {
            const bounds = g.node().getBBox();
            const fullWidth = width;
            const fullHeight = height;
            const widthScale = fullWidth / bounds.width;
            const heightScale = fullHeight / bounds.height;
            const scale = Math.min(widthScale, heightScale) * 0.9;
            const translateX = fullWidth / 2 - scale * (bounds.x + bounds.width / 2);
            const translateY = fullHeight / 2 - scale * (bounds.y + bounds.height / 2);
            
            svg.transition().call(
                zoom.transform,
                d3.zoomIdentity.translate(translateX, translateY).scale(scale)
            );
        }
        
        // ç¸¦æ¨ªåˆ‡ã‚Šæ›¿ãˆ
        function toggleOrientation() {
            isVertical = !isVertical;
            tree = isVertical 
                ? d3.tree().size([width - 200, height - 200])
                : d3.tree().size([height - 200, width - 200]);
            update(root);
        }
        
        // å…¨å±•é–‹
        function expandAll() {
            function expand(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expand);
                }
            }
            expand(root);
            update(root);
        }
        
        // å…¨æŠ˜ã‚ŠãŸãŸã¿
        function collapseAll() {
            if (root.children) {
                root.children.forEach(collapse);
                update(root);
            }
        }
        
        // è‰²å¤‰æ›´
        function changeColor(color) {
            currentColor = color;
            g.selectAll('.node circle')
                .style('fill', d => d._children ? "#FFC107" : color)
                .style('stroke', d => d._children ? "#FF8F00" : d3.rgb(color).darker());
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            document.getElementById('loading').innerHTML = `ã‚¨ãƒ©ãƒ¼: ${message}`;
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå‡¦ç†
        function handleResize() {
            width = window.innerWidth;
            height = window.innerHeight;
            
            svg.attr("width", width).attr("height", height);
            
            tree.size([width - 200, height - 200]);
            
            if (root) {
                update(root);
            }
        }
        
        // ãƒãƒ¼ãƒ‰IDç”Ÿæˆç”¨
        let nodeId = 0;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('resize', handleResize);
        
        // åˆæœŸåŒ–å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', init);
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case '+':
                    case '=':
                        event.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        event.preventDefault();
                        zoomOut();
                        break;
                    case '0':
                        event.preventDefault();
                        resetZoom();
                        break;
                }
            }
            
            switch(event.key) {
                case 'f':
                    event.preventDefault();
                    fitToScreen();
                    break;
                case 'r':
                    event.preventDefault();
                    toggleOrientation();
                    break;
                case 'e':
                    event.preventDefault();
                    expandAll();
                    break;
                case 'c':
                    event.preventDefault();
                    collapseAll();
                    break;
            }
        });
    </script>
</body>
</html>