<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ— - D3-Mind-Flow-Editor</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .controls button, .controls select {
            margin: 3px 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .controls button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .controls select {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .mindmap-svg {
            width: 100%;
            height: 100%;
            cursor: grab;
            background: transparent;
        }

        .mindmap-svg:active {
            cursor: grabbing;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node circle {
            fill: #4CAF50;
            stroke: #2E7D32;
            stroke-width: 2;
        }

        .node:hover circle {
            stroke-width: 4;
            filter: brightness(1.1) drop-shadow(0 0 10px rgba(76, 175, 80, 0.4));
        }

        .node text {
            font-size: 14px;
            font-weight: 600;
            text-anchor: middle;
            pointer-events: none;
            fill: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .link {
            fill: none;
            stroke: #999;
            stroke-width: 2;
            opacity: 0.7;
        }

        .link:hover {
            stroke-width: 4;
            opacity: 1;
        }

        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 6px;
            pointer-events: none;
            font-size: 12px;
            z-index: 1001;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .stats {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .stats div {
            margin: 5px 0;
            color: #666;
        }

        /* Color schemes */
        .color-scheme-nature .node circle { fill: #4CAF50; stroke: #2E7D32; }
        .color-scheme-ocean .node circle { fill: #2196F3; stroke: #1565C0; }
        .color-scheme-sunset .node circle { fill: #FF9800; stroke: #E65100; }
        .color-scheme-forest .node circle { fill: #388E3C; stroke: #1B5E20; }

        /* Animations */
        @keyframes nodeAppear {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .node-appear {
            animation: nodeAppear 0.5s ease-out;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .controls {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 10px;
            }
            
            .controls button, .controls select {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            .stats {
                bottom: 10px;
                right: 10px;
                left: 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <button onclick="centerView()" title="ä¸­å¤®ã«è¡¨ç¤º">ğŸ¯ ä¸­å¤®è¡¨ç¤º</button>
            <button onclick="expandAll()" title="å…¨ã¦ã®ãƒãƒ¼ãƒ‰ã‚’å±•é–‹">â• å…¨å±•é–‹</button>
            <button onclick="collapseAll()" title="å…¨ã¦ã®ãƒãƒ¼ãƒ‰ã‚’æŠ˜ã‚ŠãŸãŸã¿">â– å…¨åç´</button>
            <button onclick="autoLayout()" title="è‡ªå‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´">ğŸ”„ è‡ªå‹•é…ç½®</button>
            <select id="colorScheme" onchange="changeColorScheme()" title="ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒã‚’é¸æŠ">
                <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                <option value="nature">è‡ªç„¶</option>
                <option value="ocean">æµ·æ´‹</option>
                <option value="sunset">å¤•ç„¼ã‘</option>
                <option value="forest">æ£®æ—</option>
            </select>
            <select id="orientation" onchange="toggleOrientation()" title="æ–¹å‘ã‚’å¤‰æ›´">
                <option value="horizontal">æ¨ªå‘ã</option>
                <option value="vertical">ç¸¦å‘ã</option>
            </select>
            <button onclick="exportSVG()" title="SVGãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">ğŸ’¾ SVGå‡ºåŠ›</button>
        </div>

        <svg class="mindmap-svg" id="mindmap"></svg>

        <div class="stats">
            <h4>ğŸ“Š ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—çµ±è¨ˆ</h4>
            <div>ãƒãƒ¼ãƒ‰æ•°: <span id="nodeCount">0</span></div>
            <div>ãƒ¬ãƒ™ãƒ«æ•°: <span id="levelCount">0</span></div>
            <div>ã‚ºãƒ¼ãƒ : <span id="zoomLevel">100%</span></div>
            <div>æ–¹å‘: <span id="currentOrientation">æ¨ªå‘ã</span></div>
        </div>

        <div class="tooltip" id="tooltip" style="display: none;"></div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ï¼‰
        let mindmapData = {{DIAGRAM_DATA}};
        
        // ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„å ´åˆã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        if (!mindmapData || !mindmapData.content) {
            mindmapData = {
                name: "ä¸­å¿ƒãƒˆãƒ”ãƒƒã‚¯",
                children: [
                    {
                        name: "ãƒ¡ã‚¤ãƒ³ãƒˆãƒ”ãƒƒã‚¯1",
                        color: "#4CAF50",
                        children: [
                            { name: "ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯1-1", color: "#81C784" },
                            { name: "ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯1-2", color: "#81C784" }
                        ]
                    },
                    {
                        name: "ãƒ¡ã‚¤ãƒ³ãƒˆãƒ”ãƒƒã‚¯2", 
                        color: "#2196F3",
                        children: [
                            { name: "ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯2-1", color: "#64B5F6" },
                            { name: "ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯2-2", color: "#64B5F6" }
                        ]
                    },
                    {
                        name: "ãƒ¡ã‚¤ãƒ³ãƒˆãƒ”ãƒƒã‚¯3",
                        color: "#FF9800",
                        children: [
                            { name: "ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯3-1", color: "#FFB74D" }
                        ]
                    }
                ]
            };
        }

        // SVGè¨­å®š
        const svg = d3.select("#mindmap");
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        svg.attr("width", width).attr("height", height);

        // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
                updateZoomLevel(event.transform.k);
            });

        svg.call(zoom);

        // ãƒ¡ã‚¤ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
        const g = svg.append("g");

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
        const tooltip = d3.select("#tooltip");

        // ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ 
        const colorSchemes = {
            default: ["#4CAF50", "#2196F3", "#FF9800", "#9C27B0", "#F44336", "#00BCD4", "#FFEB3B", "#795548"],
            nature: ["#4CAF50", "#8BC34A", "#CDDC39", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#795548"],
            ocean: ["#006064", "#0097A7", "#00BCD4", "#26C6DA", "#4DD0E1", "#80DEEA", "#B2EBF2", "#E0F2F1"],
            sunset: ["#FF5722", "#FF7043", "#FF8A65", "#FFAB91", "#FFCCBC", "#FBE9E7", "#FFF3E0", "#FFF8E1"],
            forest: ["#1B5E20", "#2E7D32", "#388E3C", "#43A047", "#4CAF50", "#66BB6A", "#81C784", "#A5D6A7"]
        };

        let currentColorScheme = "default";
        let isVertical = false;

        // ãƒ„ãƒªãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
        const tree = d3.tree();
        updateTreeSize();

        // éšå±¤ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
        const root = d3.hierarchy(mindmapData);
        
        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
        const drag = d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);

        // åˆæœŸåŒ–
        updateVisualization();
        centerView();

        function updateTreeSize() {
            if (isVertical) {
                tree.size([width - 200, height - 200]);
            } else {
                tree.size([height - 200, width - 300]);
            }
        }

        function updateVisualization() {
            // æ—¢å­˜ã®è¦ç´ ã‚’ã‚¯ãƒªã‚¢
            g.selectAll("*").remove();
            
            // ãƒ„ãƒªãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨
            const treeData = tree(root);

            // ãƒªãƒ³ã‚¯ã®æç”»
            const linkGenerator = isVertical 
                ? d3.linkVertical().x(d => d.x).y(d => d.y)
                : d3.linkHorizontal().x(d => d.y).y(d => d.x);

            const links = g.selectAll(".link")
                .data(treeData.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", linkGenerator);

            // ãƒãƒ¼ãƒ‰ã®æç”»
            const nodes = g.selectAll(".node")
                .data(treeData.descendants())
                .enter()
                .append("g")
                .attr("class", "node node-appear")
                .attr("transform", d => isVertical 
                    ? `translate(${d.x + width/2 - tree.size()[0]/2}, ${d.y + 100})` 
                    : `translate(${d.y + 150}, ${d.x + height/2 - tree.size()[0]/2})`)
                .call(drag)
                .on("click", toggleNode)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            // å††ã®è¿½åŠ 
            nodes.append("circle")
                .attr("r", d => d.children ? 25 : 20)
                .style("fill", (d, i) => {
                    const colors = colorSchemes[currentColorScheme];
                    return d.data.color || colors[d.depth % colors.length];
                })
                .style("stroke", (d, i) => {
                    const colors = colorSchemes[currentColorScheme];
                    const color = d3.color(d.data.color || colors[d.depth % colors.length]);
                    return color.darker(1);
                });

            // ãƒ†ã‚­ã‚¹ãƒˆã®è¿½åŠ 
            nodes.append("text")
                .attr("dy", ".35em")
                .style("text-anchor", "middle")
                .style("font-size", d => d.children ? "14px" : "12px")
                .text(d => {
                    const name = d.data.name || "ãƒãƒ¼ãƒ‰";
                    return name.length > 8 ? name.substring(0, 8) + "..." : name;
                });

            updateStats();
        }

        // ãƒãƒ¼ãƒ‰ã®å±•é–‹/åç´
        function toggleNode(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else if (d._children) {
                d.children = d._children;
                d._children = null;
            }
            updateVisualization();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
        function dragstarted(event, d) {
            d3.select(this).raise().classed("active", true);
        }

        function dragged(event, d) {
            d.x = isVertical ? event.x - width/2 + tree.size()[0]/2 : event.y - height/2 + tree.size()[0]/2;
            d.y = isVertical ? event.y - 100 : event.x - 150;
            updateVisualization();
        }

        function dragended(event, d) {
            d3.select(this).classed("active", false);
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ©Ÿèƒ½
        function showTooltip(event, d) {
            tooltip.style("display", "block")
                .html(`
                    <strong>${d.data.name || "ãƒãƒ¼ãƒ‰"}</strong><br>
                    ãƒ¬ãƒ™ãƒ«: ${d.depth}<br>
                    å­è¦ç´ : ${(d.children || d._children || []).length}å€‹<br>
                    <small>ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/åç´</small>
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function hideTooltip() {
            tooltip.style("display", "none");
        }

        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        function updateStats() {
            const nodeCount = root.descendants().length;
            const levelCount = Math.max(...root.descendants().map(d => d.depth)) + 1;
            
            document.getElementById('nodeCount').textContent = nodeCount;
            document.getElementById('levelCount').textContent = levelCount;
        }

        function updateZoomLevel(scale) {
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + "%";
        }

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é–¢æ•°
        function centerView() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(width / 2, height / 2).scale(1)
            );
        }

        function expandAll() {
            function expand(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expand);
                }
            }
            expand(root);
            updateVisualization();
        }

        function collapseAll() {
            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                    d._children.forEach(collapse);
                }
            }
            if (root.children) {
                root.children.forEach(collapse);
            }
            updateVisualization();
        }

        function autoLayout() {
            centerView();
            setTimeout(() => {
                expandAll();
            }, 500);
        }

        function changeColorScheme() {
            currentColorScheme = document.getElementById('colorScheme').value;
            updateVisualization();
        }

        function toggleOrientation() {
            const orientation = document.getElementById('orientation').value;
            isVertical = orientation === 'vertical';
            document.getElementById('currentOrientation').textContent = 
                isVertical ? 'ç¸¦å‘ã' : 'æ¨ªå‘ã';
            
            updateTreeSize();
            updateVisualization();
        }

        function exportSVG() {
            const svgData = new XMLSerializer().serializeToString(svg.node());
            const blob = new Blob([svgData], {type: "image/svg+xml"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "mindmap.svg";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(event) {
            switch(event.code) {
                case 'KeyC':
                    if (!event.ctrlKey && !event.metaKey) centerView();
                    break;
                case 'KeyE':
                    if (!event.ctrlKey && !event.metaKey) expandAll();
                    break;
                case 'KeyQ':
                    if (!event.ctrlKey && !event.metaKey) collapseAll();
                    break;
                case 'KeyR':
                    if (!event.ctrlKey && !event.metaKey) autoLayout();
                    break;
                case 'KeyT':
                    if (!event.ctrlKey && !event.metaKey) {
                        const select = document.getElementById('orientation');
                        select.value = isVertical ? 'horizontal' : 'vertical';
                        toggleOrientation();
                    }
                    break;
            }
        });

        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            svg.attr("width", newWidth).attr("height", newHeight);
            updateTreeSize();
            updateVisualization();
        });

        // åˆæœŸè¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        console.log('ğŸ¯ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        console.log('ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: C(ä¸­å¤®), E(å±•é–‹), Q(åç´), R(è‡ªå‹•), T(æ–¹å‘åˆ‡æ›¿)');
    </script>
</body>
</html>