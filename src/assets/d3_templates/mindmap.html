<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Éû„Ç§„É≥„Éâ„Éû„ÉÉ„Éó - D3-Mind-Flow-Editor</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .controls button, .controls select {
            margin: 3px 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .controls button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .controls select {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .mindmap-svg {
            width: 100%;
            height: 100%;
            cursor: grab;
            background: transparent;
        }

        .mindmap-svg:active {
            cursor: grabbing;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node circle {
            fill: #4CAF50;
            stroke: #2E7D32;
            stroke-width: 2;
        }

        .node:hover circle {
            stroke-width: 4;
            filter: brightness(1.1) drop-shadow(0 0 10px rgba(76, 175, 80, 0.4));
        }

        .node text {
            font-size: 14px;
            font-weight: 600;
            text-anchor: middle;
            pointer-events: none;
            fill: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .link {
            fill: none;
            stroke: #999;
            stroke-width: 2;
            opacity: 0.7;
        }

        .link:hover {
            stroke-width: 4;
            opacity: 1;
        }

        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 6px;
            pointer-events: none;
            font-size: 12px;
            z-index: 1001;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .stats {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .stats div {
            margin: 5px 0;
            color: #666;
        }

        /* Color schemes */
        .color-scheme-nature .node circle { fill: #4CAF50; stroke: #2E7D32; }
        .color-scheme-ocean .node circle { fill: #2196F3; stroke: #1565C0; }
        .color-scheme-sunset .node circle { fill: #FF9800; stroke: #E65100; }
        .color-scheme-forest .node circle { fill: #388E3C; stroke: #1B5E20; }

        /* Animations */
        @keyframes nodeAppear {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .node-appear {
            animation: nodeAppear 0.5s ease-out;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .controls {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 10px;
            }
            
            .controls button, .controls select {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            .stats {
                bottom: 10px;
                right: 10px;
                left: 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <button onclick="centerView()" title="‰∏≠Â§Æ„Å´Ë°®Á§∫">üéØ ‰∏≠Â§ÆË°®Á§∫</button>
            <button onclick="expandAll()" title="ÂÖ®„Å¶„ÅÆ„Éé„Éº„Éâ„ÇíÂ±ïÈñã">‚ûï ÂÖ®Â±ïÈñã</button>
            <button onclick="collapseAll()" title="ÂÖ®„Å¶„ÅÆ„Éé„Éº„Éâ„ÇíÊäò„Çä„Åü„Åü„Åø">‚ûñ ÂÖ®ÂèéÁ¥ç</button>
            <button onclick="autoLayout()" title="Ëá™Âãï„É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥">üîÑ Ëá™ÂãïÈÖçÁΩÆ</button>
            <select id="colorScheme" onchange="changeColorScheme()" title="„Ç´„É©„Éº„ÉÜ„Éº„Éû„ÇíÈÅ∏Êäû">
                <option value="default">„Éá„Éï„Ç©„É´„Éà</option>
                <option value="nature">Ëá™ÁÑ∂</option>
                <option value="ocean">Êµ∑Ê¥ã</option>
                <option value="sunset">Â§ïÁÑº„Åë</option>
                <option value="forest">Ê£ÆÊûó</option>
            </select>
            <select id="orientation" onchange="toggleOrientation()" title="ÊñπÂêë„ÇíÂ§âÊõ¥">
                <option value="horizontal">Ê®™Âêë„Åç</option>
                <option value="vertical">Á∏¶Âêë„Åç</option>
            </select>
            <button onclick="exportSVG()" title="SVG„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">üíæ SVGÂá∫Âäõ</button>
        </div>

        <svg class="mindmap-svg" id="mindmap"></svg>

        <div class="stats">
            <h4>üìä „Éû„Ç§„É≥„Éâ„Éû„ÉÉ„ÉóÁµ±Ë®à</h4>
            <div>„Éé„Éº„ÉâÊï∞: <span id="nodeCount">0</span></div>
            <div>„É¨„Éô„É´Êï∞: <span id="levelCount">0</span></div>
            <div>„Ç∫„Éº„É†: <span id="zoomLevel">100%</span></div>
            <div>ÊñπÂêë: <span id="currentOrientation">Ê®™Âêë„Åç</span></div>
        </div>

        <div class="tooltip" id="tooltip" style="display: none;"></div>
    </div>

    <script>
        // „Éá„Éº„Çø„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÔºàÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„Å´ÁΩÆ„ÅçÊèõ„Åà„Çâ„Çå„Åæ„ÅôÔºâ
        let mindmapData = {{DIAGRAM_DATA}};
        
        // „Éá„Éº„Çø„ÅåÁÑ°„ÅÑÂ†¥Âêà„ÅÆ„Çµ„É≥„Éó„É´„Éá„Éº„Çø
        if (!mindmapData || !mindmapData.content) {
            mindmapData = {
                name: "‰∏≠ÂøÉ„Éà„Éî„ÉÉ„ÇØ",
                children: [
                    {
                        name: "„É°„Ç§„É≥„Éà„Éî„ÉÉ„ÇØ1",
                        color: "#4CAF50",
                        children: [
                            { name: "„Çµ„Éñ„Éà„Éî„ÉÉ„ÇØ1-1", color: "#81C784" },
                            { name: "„Çµ„Éñ„Éà„Éî„ÉÉ„ÇØ1-2", color: "#81C784" }
                        ]
                    },
                    {
                        name: "„É°„Ç§„É≥„Éà„Éî„ÉÉ„ÇØ2", 
                        color: "#2196F3",
                        children: [
                            { name: "„Çµ„Éñ„Éà„Éî„ÉÉ„ÇØ2-1", color: "#64B5F6" },
                            { name: "„Çµ„Éñ„Éà„Éî„ÉÉ„ÇØ2-2", color: "#64B5F6" }
                        ]
                    },
                    {
                        name: "„É°„Ç§„É≥„Éà„Éî„ÉÉ„ÇØ3",
                        color: "#FF9800",
                        children: [
                            { name: "„Çµ„Éñ„Éà„Éî„ÉÉ„ÇØ3-1", color: "#FFB74D" }
                        ]
                    }
                ]
            };
        }

        // SVGË®≠ÂÆö
        const svg = d3.select("#mindmap");
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        svg.attr("width", width).attr("height", height);

        // „Ç∫„Éº„É†Ê©üËÉΩ
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
                updateZoomLevel(event.transform.k);
            });

        svg.call(zoom);

        // „É°„Ç§„É≥„Ç∞„É´„Éº„Éó
        const g = svg.append("g");

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
        const tooltip = d3.select("#tooltip");

        // „Ç´„É©„Éº„Çπ„Ç≠„Éº„É†
        const colorSchemes = {
            default: ["#4CAF50", "#2196F3", "#FF9800", "#9C27B0", "#F44336", "#00BCD4", "#FFEB3B", "#795548"],
            nature: ["#4CAF50", "#8BC34A", "#CDDC39", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#795548"],
            ocean: ["#006064", "#0097A7", "#00BCD4", "#26C6DA", "#4DD0E1", "#80DEEA", "#B2EBF2", "#E0F2F1"],
            sunset: ["#FF5722", "#FF7043", "#FF8A65", "#FFAB91", "#FFCCBC", "#FBE9E7", "#FFF3E0", "#FFF8E1"],
            forest: ["#1B5E20", "#2E7D32", "#388E3C", "#43A047", "#4CAF50", "#66BB6A", "#81C784", "#A5D6A7"]
        };

        let currentColorScheme = "default";
        let isVertical = false;

        // „ÉÑ„É™„Éº„É¨„Ç§„Ç¢„Ç¶„Éà
        const tree = d3.tree();
        updateTreeSize();

        // ÈöéÂ±§„Éá„Éº„Çø„ÅÆ‰ΩúÊàê
        const root = d3.hierarchy(mindmapData);
        
        // „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ
        const drag = d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);

        // ÂàùÊúüÂåñ
        updateVisualization();
        centerView();

        function updateTreeSize() {
            if (isVertical) {
                tree.size([width - 200, height - 200]);
            } else {
                tree.size([height - 200, width - 300]);
            }
        }

        function updateVisualization() {
            // Êó¢Â≠ò„ÅÆË¶ÅÁ¥†„Çí„ÇØ„É™„Ç¢
            g.selectAll("*").remove();
            
            // „ÉÑ„É™„Éº„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÈÅ©Áî®
            const treeData = tree(root);

            // „É™„É≥„ÇØ„ÅÆÊèèÁîª
            const linkGenerator = isVertical 
                ? d3.linkVertical().x(d => d.x).y(d => d.y)
                : d3.linkHorizontal().x(d => d.y).y(d => d.x);

            const links = g.selectAll(".link")
                .data(treeData.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", linkGenerator);

            // „Éé„Éº„Éâ„ÅÆÊèèÁîª
            const nodes = g.selectAll(".node")
                .data(treeData.descendants())
                .enter()
                .append("g")
                .attr("class", "node node-appear")
                .attr("transform", d => isVertical 
                    ? `translate(${d.x + width/2 - tree.size()[0]/2}, ${d.y + 100})` 
                    : `translate(${d.y + 150}, ${d.x + height/2 - tree.size()[0]/2})`)
                .call(drag)
                .on("click", toggleNode)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            // ÂÜÜ„ÅÆËøΩÂä†
            nodes.append("circle")
                .attr("r", d => d.children ? 25 : 20)
                .style("fill", (d, i) => {
                    const colors = colorSchemes[currentColorScheme];
                    return d.data.color || colors[d.depth % colors.length];
                })
                .style("stroke", (d, i) => {
                    const colors = colorSchemes[currentColorScheme];
                    const color = d3.color(d.data.color || colors[d.depth % colors.length]);
                    return color.darker(1);
                });

            // „ÉÜ„Ç≠„Çπ„Éà„ÅÆËøΩÂä†
            nodes.append("text")
                .attr("dy", ".35em")
                .style("text-anchor", "middle")
                .style("font-size", d => d.children ? "14px" : "12px")
                .text(d => {
                    const name = d.data.name || "„Éé„Éº„Éâ";
                    return name.length > 8 ? name.substring(0, 8) + "..." : name;
                });

            updateStats();
        }

        // „Éé„Éº„Éâ„ÅÆÂ±ïÈñã/ÂèéÁ¥ç
        function toggleNode(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else if (d._children) {
                d.children = d._children;
                d._children = null;
            }
            updateVisualization();
        }

        // „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ
        function dragstarted(event, d) {
            d3.select(this).raise().classed("active", true);
        }

        function dragged(event, d) {
            d.x = isVertical ? event.x - width/2 + tree.size()[0]/2 : event.y - height/2 + tree.size()[0]/2;
            d.y = isVertical ? event.y - 100 : event.x - 150;
            updateVisualization();
        }

        function dragended(event, d) {
            d3.select(this).classed("active", false);
        }

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÊ©üËÉΩ
        function showTooltip(event, d) {
            tooltip.style("display", "block")
                .html(`
                    <strong>${d.data.name || "„Éé„Éº„Éâ"}</strong><br>
                    „É¨„Éô„É´: ${d.depth}<br>
                    Â≠êË¶ÅÁ¥†: ${(d.children || d._children || []).length}ÂÄã<br>
                    <small>„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ±ïÈñã/ÂèéÁ¥ç</small>
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function hideTooltip() {
            tooltip.style("display", "none");
        }

        // Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
        function updateStats() {
            const nodeCount = root.descendants().length;
            const levelCount = Math.max(...root.descendants().map(d => d.depth)) + 1;
            
            document.getElementById('nodeCount').textContent = nodeCount;
            document.getElementById('levelCount').textContent = levelCount;
        }

        function updateZoomLevel(scale) {
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + "%";
        }

        // „Ç≥„É≥„Éà„É≠„Éº„É´Èñ¢Êï∞
        function centerView() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(width / 2, height / 2).scale(1)
            );
        }

        function expandAll() {
            function expand(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expand);
                }
            }
            expand(root);
            updateVisualization();
        }

        function collapseAll() {
            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                    d._children.forEach(collapse);
                }
            }
            if (root.children) {
                root.children.forEach(collapse);
            }
            updateVisualization();
        }

        function autoLayout() {
            centerView();
            setTimeout(() => {
                expandAll();
            }, 500);
        }

        function changeColorScheme() {
            currentColorScheme = document.getElementById('colorScheme').value;
            updateVisualization();
        }

        function toggleOrientation() {
            const orientation = document.getElementById('orientation').value;
            isVertical = orientation === 'vertical';
            document.getElementById('currentOrientation').textContent = 
                isVertical ? 'Á∏¶Âêë„Åç' : 'Ê®™Âêë„Åç';
            
            updateTreeSize();
            updateVisualization();
        }

        function exportSVG() {
            const svgData = new XMLSerializer().serializeToString(svg.node());
            const blob = new Blob([svgData], {type: "image/svg+xml"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "mindmap.svg";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', function(event) {
            switch(event.code) {
                case 'KeyC':
                    if (!event.ctrlKey && !event.metaKey) centerView();
                    break;
                case 'KeyE':
                    if (!event.ctrlKey && !event.metaKey) expandAll();
                    break;
                case 'KeyQ':
                    if (!event.ctrlKey && !event.metaKey) collapseAll();
                    break;
                case 'KeyR':
                    if (!event.ctrlKey && !event.metaKey) autoLayout();
                    break;
                case 'KeyT':
                    if (!event.ctrlKey && !event.metaKey) {
                        const select = document.getElementById('orientation');
                        select.value = isVertical ? 'horizontal' : 'vertical';
                        toggleOrientation();
                    }
                    break;
            }
        });

        // „É™„Çµ„Ç§„Ç∫ÂØæÂøú
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            svg.attr("width", newWidth).attr("height", newHeight);
            updateTreeSize();
            updateVisualization();
        });

        // ÂàùÊúüË°®Á§∫„É°„ÉÉ„Çª„Éº„Ç∏
        console.log('üéØ „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Éû„Ç§„É≥„Éâ„Éû„ÉÉ„Éó„ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü');
        console.log('„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà: C(‰∏≠Â§Æ), E(Â±ïÈñã), Q(ÂèéÁ¥ç), R(Ëá™Âãï), T(ÊñπÂêëÂàáÊõø)');
    </script>
</body>
</html>