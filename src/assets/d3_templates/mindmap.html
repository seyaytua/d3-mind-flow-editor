<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éû„Ç§„É≥„Éâ„Éû„ÉÉ„Éó - {{ TITLE }}</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }
        
        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            min-width: 200px;
        }
        
        #controls button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        #controls button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        #controls button:active {
            transform: translateY(0);
        }
        
        #controls input[type="color"] {
            width: 40px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        #mindmap {
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle, #ffffff 0%, #f8f9fa 100%);
        }
        
        .node circle {
            fill: #4CAF50;
            stroke: #2E7D32;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .node circle:hover {
            fill: #66BB6A;
            stroke-width: 3px;
            r: 25;
        }
        
        .node text {
            font-family: inherit;
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
            user-select: none;
        }
        
        .link {
            fill: none;
            stroke: #8BC34A;
            stroke-width: 2px;
            transition: all 0.3s ease;
        }
        
        .link:hover {
            stroke: #4CAF50;
            stroke-width: 3px;
        }
        
        .node.collapsed circle {
            fill: #FFC107;
            stroke: #FF8F00;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        /* Loading spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç≥„É≥„Éà„É≠„Éº„É©„Éº -->
    <div id="controls">
        <button onclick="zoomIn()" title="„Ç∫„Éº„É†„Ç§„É≥">üîç+</button>
        <button onclick="zoomOut()" title="„Ç∫„Éº„É†„Ç¢„Ç¶„Éà">üîç-</button>
        <button onclick="resetZoom()" title="„É™„Çª„ÉÉ„Éà">‚ü≤</button>
        <button onclick="toggleOrientation()" title="Á∏¶Ê®™ÂàáÊõø">‚¨å</button>
        <button onclick="expandAll()" title="ÂÖ®Â±ïÈñã">üìÇ</button>
        <button onclick="collapseAll()" title="ÂÖ®Êäò„Çä„Åü„Åü„Åø">üìÅ</button>
        <input type="color" value="#4CAF50" onchange="changeColor(this.value)" title="Ëâ≤Â§âÊõ¥">
        <button onclick="fitToScreen()" title="ÁîªÈù¢„Å´Âêà„Çè„Åõ„Çã">üìê</button>
    </div>
    
    <!-- „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó -->
    <div id="tooltip" class="tooltip"></div>
    
    <!-- SVG„Ç≥„É≥„ÉÜ„Éä -->
    <svg id="mindmap"></svg>
    
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
    <div id="loading" class="loading">„Éû„Ç§„É≥„Éâ„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let svg, g, tree, root, zoom, tooltip;
        let currentColor = "#4CAF50";
        let isVertical = true;
        let width = window.innerWidth;
        let height = window.innerHeight;
        
        // „Éá„Éº„ÇøË®≠ÂÆöÔºà„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊï∞„ÅßÁΩÆÊèõ„Åï„Çå„ÇãÔºâ
        const data = {{ JSON_DATA }};
        
        // ÂàùÊúüÂåñ
        function init() {
            // SVGË¶ÅÁ¥†„ÅÆË®≠ÂÆö
            svg = d3.select("#mindmap")
                .attr("width", width)
                .attr("height", height);
            
            // „Ç∫„Éº„É†Ê©üËÉΩ„ÅÆË®≠ÂÆö
            zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            
            svg.call(zoom);
            
            // „É°„Ç§„É≥„Ç∞„É´„Éº„Éó
            g = svg.append("g");
            
            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆË®≠ÂÆö
            tooltip = d3.select("#tooltip");
            
            // „ÉÑ„É™„Éº„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆË®≠ÂÆö
            tree = d3.tree().size([width - 200, height - 200]);
            
            // „Éá„Éº„Çø„ÅÆÂ§âÊèõ„Å®ÊèèÁîª
            if (data) {
                root = d3.hierarchy(data);
                root.x0 = width / 2;
                root.y0 = height / 2;
                
                // ÂàùÊúüÁä∂ÊÖã„Åß„ÅØ‰∏ÄÈÉ®„ÇíÊäò„Çä„Åü„Åü„Åø
                if (root.children) {
                    root.children.forEach(collapse);
                }
                
                update(root);
                hideLoading();
            } else {
                showError("„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
            }
        }
        
        // „Éé„Éº„Éâ„ÅÆÊõ¥Êñ∞
        function update(source) {
            // „ÉÑ„É™„Éº„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆË®àÁÆó
            const treeData = tree(root);
            const nodes = treeData.descendants();
            const links = treeData.descendants().slice(1);
            
            // „Éé„Éº„Éâ„ÅÆ‰ΩçÁΩÆË™øÊï¥ÔºàÁ∏¶Ê®™Âàá„ÇäÊõø„ÅàÂØæÂøúÔºâ
            if (!isVertical) {
                nodes.forEach(d => {
                    const temp = d.x;
                    d.x = d.y;
                    d.y = temp;
                });
            }
            
            // „Éé„Éº„Éâ„ÅÆÊèèÁîª
            const node = g.selectAll('.node')
                .data(nodes, d => d.id || (d.id = ++nodeId));
            
            // Êñ∞„Åó„ÅÑ„Éé„Éº„Éâ„ÅÆËøΩÂä†
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${source.x0 || 0},${source.y0 || 0})`)
                .on('click', click)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);
            
            // ÂÜÜ„ÅÆËøΩÂä†
            nodeEnter.append('circle')
                .attr('r', 1e-6)
                .style('fill', d => d._children ? "#FFC107" : currentColor)
                .style('stroke', d => d._children ? "#FF8F00" : d3.rgb(currentColor).darker());
            
            // „ÉÜ„Ç≠„Çπ„Éà„ÅÆËøΩÂä†
            nodeEnter.append('text')
                .attr('dy', '.35em')
                .attr('text-anchor', 'middle')
                .text(d => d.data.name)
                .style('fill-opacity', 1e-6);
            
            // „Éé„Éº„Éâ„ÅÆÊõ¥Êñ∞
            const nodeUpdate = nodeEnter.merge(node);
            
            // ‰ΩçÁΩÆ„Å®„Çπ„Çø„Ç§„É´„ÅÆÊõ¥Êñ∞
            nodeUpdate.transition()
                .duration(750)
                .attr('transform', d => `translate(${d.x},${d.y})`);
            
            nodeUpdate.select('circle')
                .transition()
                .duration(750)
                .attr('r', 20)
                .style('fill', d => d._children ? "#FFC107" : currentColor)
                .style('stroke', d => d._children ? "#FF8F00" : d3.rgb(currentColor).darker());
            
            nodeUpdate.select('text')
                .transition()
                .duration(750)
                .style('fill-opacity', 1);
            
            // ‰∏çË¶Å„Å™„Éé„Éº„Éâ„ÅÆÂâäÈô§
            const nodeExit = node.exit().transition()
                .duration(750)
                .attr('transform', d => `translate(${source.x},${source.y})`)
                .remove();
            
            nodeExit.select('circle')
                .attr('r', 1e-6);
            
            nodeExit.select('text')
                .style('fill-opacity', 1e-6);
            
            // „É™„É≥„ÇØ„ÅÆÊèèÁîª
            const link = g.selectAll('.link')
                .data(links, d => d.id);
            
            // Êñ∞„Åó„ÅÑ„É™„É≥„ÇØ„ÅÆËøΩÂä†
            const linkEnter = link.enter().insert('path', 'g')
                .attr('class', 'link')
                .attr('d', d => {
                    const o = {x: source.x0 || 0, y: source.y0 || 0};
                    return diagonal(o, o);
                });
            
            // „É™„É≥„ÇØ„ÅÆÊõ¥Êñ∞
            const linkUpdate = linkEnter.merge(link);
            
            linkUpdate.transition()
                .duration(750)
                .attr('d', d => diagonal(d, d.parent));
            
            // ‰∏çË¶Å„Å™„É™„É≥„ÇØ„ÅÆÂâäÈô§
            const linkExit = link.exit().transition()
                .duration(750)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();
            
            // ÂâçÂõû„ÅÆ‰ΩçÁΩÆ„Çí‰øùÂ≠ò
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }
        
        // ÂØæËßíÁ∑öÔºà„Éô„Ç∏„ÇßÊõ≤Á∑öÔºâ„ÅÆË®àÁÆó
        function diagonal(s, d) {
            const path = `M ${s.x} ${s.y}
                         C ${s.x} ${(s.y + d.y) / 2},
                           ${d.x} ${(s.y + d.y) / 2},
                           ${d.x} ${d.y}`;
            return path;
        }
        
        // „Éé„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            update(d);
        }
        
        // „Éé„Éº„ÉâÊäò„Çä„Åü„Åü„Åø
        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }
        
        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË°®Á§∫
        function showTooltip(event, d) {
            tooltip.style("opacity", 1)
                .html(`<strong>${d.data.name}</strong><br>„É¨„Éô„É´: ${d.depth}<br>Â≠ê„Éé„Éº„Éâ: ${d.children ? d.children.length : d._children ? d._children.length : 0}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }
        
        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÈùûË°®Á§∫
        function hideTooltip() {
            tooltip.style("opacity", 0);
        }
        
        // „Ç∫„Éº„É†„Ç§„É≥
        function zoomIn() {
            svg.transition().call(
                zoom.scaleBy, 1.2
            );
        }
        
        // „Ç∫„Éº„É†„Ç¢„Ç¶„Éà
        function zoomOut() {
            svg.transition().call(
                zoom.scaleBy, 0.8
            );
        }
        
        // „Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà
        function resetZoom() {
            svg.transition().call(
                zoom.transform,
                d3.zoomIdentity.translate(width / 2, height / 2).scale(1)
            );
        }
        
        // ÁîªÈù¢„Å´Âêà„Çè„Åõ„Çã
        function fitToScreen() {
            const bounds = g.node().getBBox();
            const fullWidth = width;
            const fullHeight = height;
            const widthScale = fullWidth / bounds.width;
            const heightScale = fullHeight / bounds.height;
            const scale = Math.min(widthScale, heightScale) * 0.9;
            const translateX = fullWidth / 2 - scale * (bounds.x + bounds.width / 2);
            const translateY = fullHeight / 2 - scale * (bounds.y + bounds.height / 2);
            
            svg.transition().call(
                zoom.transform,
                d3.zoomIdentity.translate(translateX, translateY).scale(scale)
            );
        }
        
        // Á∏¶Ê®™Âàá„ÇäÊõø„Åà
        function toggleOrientation() {
            isVertical = !isVertical;
            tree = isVertical 
                ? d3.tree().size([width - 200, height - 200])
                : d3.tree().size([height - 200, width - 200]);
            update(root);
        }
        
        // ÂÖ®Â±ïÈñã
        function expandAll() {
            function expand(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expand);
                }
            }
            expand(root);
            update(root);
        }
        
        // ÂÖ®Êäò„Çä„Åü„Åü„Åø
        function collapseAll() {
            if (root.children) {
                root.children.forEach(collapse);
                update(root);
            }
        }
        
        // Ëâ≤Â§âÊõ¥
        function changeColor(color) {
            currentColor = color;
            g.selectAll('.node circle')
                .style('fill', d => d._children ? "#FFC107" : color)
                .style('stroke', d => d._children ? "#FF8F00" : d3.rgb(color).darker());
        }
        
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            document.getElementById('loading').innerHTML = `„Ç®„É©„Éº: ${message}`;
        }
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫Âá¶ÁêÜ
        function handleResize() {
            width = window.innerWidth;
            height = window.innerHeight;
            
            svg.attr("width", width).attr("height", height);
            
            tree.size([width - 200, height - 200]);
            
            if (root) {
                update(root);
            }
        }
        
        // „Éé„Éº„ÉâIDÁîüÊàêÁî®
        let nodeId = 0;
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        window.addEventListener('resize', handleResize);
        
        // ÂàùÊúüÂåñÂÆüË°å
        document.addEventListener('DOMContentLoaded', init);
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case '+':
                    case '=':
                        event.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        event.preventDefault();
                        zoomOut();
                        break;
                    case '0':
                        event.preventDefault();
                        resetZoom();
                        break;
                }
            }
            
            switch(event.key) {
                case 'f':
                    event.preventDefault();
                    fitToScreen();
                    break;
                case 'r':
                    event.preventDefault();
                    toggleOrientation();
                    break;
                case 'e':
                    event.preventDefault();
                    expandAll();
                    break;
                case 'c':
                    event.preventDefault();
                    collapseAll();
                    break;
            }
        });
    </script>
</body>
</html>