<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà - {{ TITLE }}</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }
        
        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            min-width: 200px;
        }
        
        #controls button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #FF9800;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        #controls button:hover {
            background: #F57C00;
            transform: translateY(-1px);
        }
        
        #controls select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            min-height: 600px;
        }
        
        h1 {
            margin: 0 0 20px 0;
            color: #333;
            text-align: center;
        }
        
        #flowchart {
            width: 100%;
            min-height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Mermaid „Çπ„Çø„Ç§„É´„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        .node rect,
        .node circle,
        .node ellipse,
        .node polygon,
        .node path {
            fill: #fff;
            stroke: #FF9800;
            stroke-width: 2px;
        }
        
        .node text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            fill: #333;
        }
        
        .edgePath path {
            stroke: #666;
            stroke-width: 2px;
            fill: none;
        }
        
        .edgeLabel {
            background-color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
        }
        
        /* „Éé„Éº„Éâ„Çø„Ç§„ÉóÂà•„ÅÆ„Çπ„Çø„Ç§„É´ */
        .flowchart-start-node rect {
            fill: #4CAF50;
            stroke: #2E7D32;
        }
        
        .flowchart-start-node text {
            fill: white;
        }
        
        .flowchart-end-node rect {
            fill: #F44336;
            stroke: #C62828;
        }
        
        .flowchart-end-node text {
            fill: white;
        }
        
        .flowchart-decision-node polygon {
            fill: #FFC107;
            stroke: #FF8F00;
        }
        
        .flowchart-process-node rect {
            fill: #2196F3;
            stroke: #1565C0;
        }
        
        .flowchart-process-node text {
            fill: white;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.2s ease;
            max-width: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            font-size: 16px;
            color: #F44336;
            background: #FFEBEE;
            border-radius: 8px;
            border: 1px solid #FFCDD2;
        }
        
        .mermaid-container {
            width: 100%;
            overflow: auto;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 768px) {
            #controls {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }
            
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
        }
        
        /* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂØæÂøú */
        @media (prefers-color-scheme: dark) {
            body {
                background: #121212;
                color: #fff;
            }
            
            .container {
                background: #1e1e1e;
                color: #fff;
            }
            
            #controls {
                background: rgba(30, 30, 30, 0.95);
                color: #fff;
            }
        }
    </style>
</head>
<body>
    <!-- „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç≥„É≥„Éà„É≠„Éº„É©„Éº -->
    <div id="controls">
        <button onclick="zoomIn()" title="„Ç∫„Éº„É†„Ç§„É≥">üîç+</button>
        <button onclick="zoomOut()" title="„Ç∫„Éº„É†„Ç¢„Ç¶„Éà">üîç-</button>
        <button onclick="resetZoom()" title="„É™„Çª„ÉÉ„Éà">‚ü≤</button>
        <button onclick="fitToScreen()" title="ÁîªÈù¢„Å´Âêà„Çè„Åõ„Çã">üìê</button>
        <select id="themeSelect" onchange="changeTheme(this.value)">
            <option value="default">„Éá„Éï„Ç©„É´„Éà</option>
            <option value="dark">„ÉÄ„Éº„ÇØ</option>
            <option value="forest">„Éï„Ç©„É¨„Çπ„Éà</option>
            <option value="neutral">„Éã„É•„Éº„Éà„É©„É´</option>
        </select>
        <button onclick="downloadSVG()" title="SVG„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">üíæ</button>
        <button onclick="toggleFullscreen()" title="„Éï„É´„Çπ„ÇØ„É™„Éº„É≥">üî≥</button>
    </div>
    
    <div class="container">
        <h1>{{ TITLE }}</h1>
        
        <!-- „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó -->
        <div id="tooltip" class="tooltip"></div>
        
        <!-- „Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„Ç≥„É≥„ÉÜ„Éä -->
        <div id="flowchart-container" class="mermaid-container">
            <div id="flowchart">
                <div id="loading" class="loading">„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
        </div>
    </div>
    
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentScale = 1;
        let currentTheme = 'default';
        let mermaidInitialized = false;
        let tooltip;
        
        // Mermaid„Éá„Éº„ÇøÔºà„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊï∞„ÅßÁΩÆÊèõ„Åï„Çå„ÇãÔºâ
        const mermaidCode = `{{ MERMAID_DATA }}`;
        
        // MermaidË®≠ÂÆö
        const mermaidConfig = {
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                primaryColor: '#FF9800',
                primaryTextColor: '#333',
                primaryBorderColor: '#F57C00',
                lineColor: '#666',
                sectionBkgColor: '#fff',
                altSectionBkgColor: '#f8f9fa',
                gridColor: '#e0e0e0'
            }
        };
        
        // ÂàùÊúüÂåñ
        function init() {
            try {
                // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË®≠ÂÆö
                tooltip = d3.select("#tooltip");
                
                // Mermaid„ÅÆÂàùÊúüÂåñ
                mermaid.initialize(mermaidConfig);
                mermaidInitialized = true;
                
                // „Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅÆÊèèÁîª
                if (mermaidCode && mermaidCode.trim() && mermaidCode !== '{{ MERMAID_DATA }}') {
                    renderFlowchart();
                } else {
                    showError("„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError("ÂàùÊúüÂåñ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: " + error.message);
            }
        }
        
        // „Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅÆÊèèÁîª
        async function renderFlowchart() {
            try {
                hideLoading();
                
                const flowchartElement = document.getElementById('flowchart');
                flowchartElement.innerHTML = '';
                
                // Mermaid„Åß„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                const { svg } = await mermaid.render('flowchart-diagram', mermaidCode);
                
                // SVG„ÇíÊåøÂÖ•
                flowchartElement.innerHTML = svg;
                
                // SVGË¶ÅÁ¥†„Å´ÂØæ„Åó„Å¶„Ç∫„Éº„É†„Å®„Éë„É≥„ÇíË®≠ÂÆö
                setupZoomAndPan();
                
                // „Éé„Éº„Éâ„Å´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
                setupNodeInteractions();
                
                console.log('Flowchart rendered successfully');
                
            } catch (error) {
                console.error('Rendering error:', error);
                showError("„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅÆÊèèÁîª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
            }
        }
        
        // „Ç∫„Éº„É†„Å®„Éë„É≥„ÅÆË®≠ÂÆö
        function setupZoomAndPan() {
            const svgElement = document.querySelector('#flowchart svg');
            if (!svgElement) return;
            
            const svg = d3.select(svgElement);
            const g = svg.select('g');
            
            // „Ç∫„Éº„É†Âãï‰Ωú„ÅÆÂÆöÁæ©
            const zoom = d3.zoom()
                .scaleExtent([0.1, 5])
                .on('zoom', (event) => {
                    currentScale = event.transform.k;
                    g.attr('transform', event.transform);
                });
            
            // SVG„Å´„Ç∫„Éº„É†Ê©üËÉΩ„ÇíÈÅ©Áî®
            svg.call(zoom);
            
            // ÂàùÊúü„ÅÆ„Ç∫„Éº„É†„É¨„Éô„É´„ÇíË®≠ÂÆö
            const bbox = g.node().getBBox();
            const containerWidth = svgElement.parentElement.clientWidth;
            const containerHeight = svgElement.parentElement.clientHeight;
            
            if (bbox.width > 0 && bbox.height > 0) {
                const scale = Math.min(containerWidth / bbox.width, containerHeight / bbox.height) * 0.8;
                const translateX = (containerWidth - bbox.width * scale) / 2 - bbox.x * scale;
                const translateY = (containerHeight - bbox.height * scale) / 2 - bbox.y * scale;
                
                svg.call(zoom.transform, d3.zoomIdentity.translate(translateX, translateY).scale(scale));
                currentScale = scale;
            }
        }
        
        // „Éé„Éº„Éâ„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥Ë®≠ÂÆö
        function setupNodeInteractions() {
            const nodes = document.querySelectorAll('#flowchart .node');
            
            nodes.forEach(node => {
                // „Éû„Ç¶„Çπ„Ç™„Éº„Éê„Éº„Åß„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË°®Á§∫
                node.addEventListener('mouseover', (event) => {
                    const nodeId = node.id;
                    const textElement = node.querySelector('text');
                    const nodeText = textElement ? textElement.textContent : nodeId;
                    
                    showNodeTooltip(event, nodeText, getNodeType(node));
                });
                
                // „Éû„Ç¶„Çπ„Ç¢„Ç¶„Éà„Åß„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÈùûË°®Á§∫
                node.addEventListener('mouseout', () => {
                    hideTooltip();
                });
                
                // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                node.addEventListener('click', (event) => {
                    const nodeId = node.id;
                    console.log('Node clicked:', nodeId);
                    highlightNode(node);
                });
            });
        }
        
        // „Éé„Éº„Éâ„Çø„Ç§„Éó„ÅÆÂà§ÂÆö
        function getNodeType(node) {
            if (node.classList.contains('start') || node.textContent.includes('ÈñãÂßã') || node.textContent.includes('start')) {
                return 'ÈñãÂßã„Éé„Éº„Éâ';
            } else if (node.classList.contains('end') || node.textContent.includes('ÁµÇ‰∫Ü') || node.textContent.includes('end')) {
                return 'ÁµÇ‰∫Ü„Éé„Éº„Éâ';
            } else if (node.querySelector('polygon')) {
                return 'Âà§ÂÆö„Éé„Éº„Éâ';
            } else if (node.querySelector('rect')) {
                return 'Âá¶ÁêÜ„Éé„Éº„Éâ';
            } else if (node.querySelector('circle')) {
                return 'ÂÜÜÂΩ¢„Éé„Éº„Éâ';
            }
            return '„Éé„Éº„Éâ';
        }
        
        // „Éé„Éº„Éâ„ÅÆ„Éè„Ç§„É©„Ç§„Éà
        function highlightNode(node) {
            // Êó¢Â≠ò„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíÂâäÈô§
            document.querySelectorAll('.highlighted').forEach(n => {
                n.classList.remove('highlighted');
            });
            
            // Êñ∞„Åó„ÅÑ„Éè„Ç§„É©„Ç§„Éà„ÇíËøΩÂä†
            node.classList.add('highlighted');
            
            // „Çπ„Çø„Ç§„É´„ÇíÂãïÁöÑ„Å´ËøΩÂä†
            if (!document.querySelector('#highlight-style')) {
                const style = document.createElement('style');
                style.id = 'highlight-style';
                style.textContent = `
                    .highlighted rect,
                    .highlighted circle,
                    .highlighted ellipse,
                    .highlighted polygon,
                    .highlighted path {
                        stroke: #FF5722 !important;
                        stroke-width: 4px !important;
                        filter: drop-shadow(0 0 8px rgba(255, 87, 34, 0.6));
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // „Éé„Éº„Éâ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË°®Á§∫
        function showNodeTooltip(event, nodeText, nodeType) {
            tooltip.style("opacity", 1)
                .html(`
                    <strong>${nodeText}</strong><br>
                    „Çø„Ç§„Éó: ${nodeType}<br>
                    <em>„ÇØ„É™„ÉÉ„ÇØ„Åß„Éè„Ç§„É©„Ç§„Éà</em>
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }
        
        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÈùûË°®Á§∫
        function hideTooltip() {
            tooltip.style("opacity", 0);
        }
        
        // „Ç∫„Éº„É†„Ç§„É≥
        function zoomIn() {
            const svgElement = document.querySelector('#flowchart svg');
            if (svgElement) {
                const svg = d3.select(svgElement);
                svg.transition().call(
                    d3.zoom().scaleBy, 1.2
                );
            }
        }
        
        // „Ç∫„Éº„É†„Ç¢„Ç¶„Éà
        function zoomOut() {
            const svgElement = document.querySelector('#flowchart svg');
            if (svgElement) {
                const svg = d3.select(svgElement);
                svg.transition().call(
                    d3.zoom().scaleBy, 0.8
                );
            }
        }
        
        // „Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà
        function resetZoom() {
            const svgElement = document.querySelector('#flowchart svg');
            if (svgElement) {
                const svg = d3.select(svgElement);
                const g = svg.select('g');
                
                svg.transition().call(
                    d3.zoom().transform,
                    d3.zoomIdentity
                );
                currentScale = 1;
            }
        }
        
        // ÁîªÈù¢„Å´Âêà„Çè„Åõ„Çã
        function fitToScreen() {
            const svgElement = document.querySelector('#flowchart svg');
            if (svgElement) {
                const svg = d3.select(svgElement);
                const g = svg.select('g');
                const bbox = g.node().getBBox();
                
                const containerWidth = svgElement.parentElement.clientWidth;
                const containerHeight = svgElement.parentElement.clientHeight;
                
                if (bbox.width > 0 && bbox.height > 0) {
                    const scale = Math.min(containerWidth / bbox.width, containerHeight / bbox.height) * 0.9;
                    const translateX = (containerWidth - bbox.width * scale) / 2 - bbox.x * scale;
                    const translateY = (containerHeight - bbox.height * scale) / 2 - bbox.y * scale;
                    
                    svg.transition().call(
                        d3.zoom().transform,
                        d3.zoomIdentity.translate(translateX, translateY).scale(scale)
                    );
                    currentScale = scale;
                }
            }
        }
        
        // „ÉÜ„Éº„ÉûÂ§âÊõ¥
        function changeTheme(theme) {
            currentTheme = theme;
            
            const themeConfig = {
                ...mermaidConfig,
                theme: theme
            };
            
            mermaid.initialize(themeConfig);
            
            // ÂÜçÊèèÁîª
            renderFlowchart();
        }
        
        // SVG„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadSVG() {
            const svgElement = document.querySelector('#flowchart svg');
            if (svgElement) {
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const svgBlob = new Blob([svgData], {type: "image/svg+xml;charset=utf-8"});
                const svgUrl = URL.createObjectURL(svgBlob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = svgUrl;
                downloadLink.download = 'flowchart.svg';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(svgUrl);
            }
        }
        
        // „Éï„É´„Çπ„ÇØ„É™„Éº„É≥Âàá„ÇäÊõø„Åà
        function toggleFullscreen() {
            const container = document.querySelector('.container');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = 'none';
            }
        }
        
        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            const flowchartElement = document.getElementById('flowchart');
            flowchartElement.innerHTML = `
                <div class="error">
                    <h3>‚ö†Ô∏è „Ç®„É©„Éº</h3>
                    <p>${message}</p>
                    <details>
                        <summary>„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</summary>
                        <pre>Mermaid„Ç≥„Éº„Éâ:
${mermaidCode || '„Éá„Éº„Çø„Å™„Åó'}</pre>
                    </details>
                </div>
            `;
        }
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫Âá¶ÁêÜ
        function handleResize() {
            if (document.querySelector('#flowchart svg')) {
                setTimeout(fitToScreen, 100);
            }
        }
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (event) => {
                if (event.ctrlKey || event.metaKey) {
                    switch(event.key) {
                        case '+':
                        case '=':
                            event.preventDefault();
                            zoomIn();
                            break;
                        case '-':
                            event.preventDefault();
                            zoomOut();
                            break;
                        case '0':
                            event.preventDefault();
                            resetZoom();
                            break;
                    }
                }
                
                switch(event.key) {
                    case 'f':
                        event.preventDefault();
                        fitToScreen();
                        break;
                    case 'F11':
                        event.preventDefault();
                        toggleFullscreen();
                        break;
                    case 's':
                        if (event.ctrlKey || event.metaKey) {
                            event.preventDefault();
                            downloadSVG();
                        }
                        break;
                }
            });
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        window.addEventListener('resize', handleResize);
        
        // ÂàùÊúüÂåñÂÆüË°å
        document.addEventListener('DOMContentLoaded', () => {
            setupKeyboardShortcuts();
            init();
        });
        
        // Mermaid„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', (event) => {
            if (event.message && event.message.includes('mermaid')) {
                console.error('Mermaid error:', event.error);
                showError("Mermaid„ÅÆÊèèÁîª„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: " + event.message);
            }
        });
    </script>
</body>
</html>