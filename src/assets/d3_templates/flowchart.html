<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà - D3-Mind-Flow-Editor</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h2 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .controls button, .controls select {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .controls button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .controls select {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .flowchart-container {
            position: absolute;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 20px;
            overflow: hidden;
        }

        .mermaid-wrapper {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
        }

        #flowchart {
            width: 100%;
            height: 100%;
            text-align: center;
            overflow: auto;
            cursor: grab;
        }

        #flowchart:active {
            cursor: grabbing;
        }

        .mermaid {
            background: transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .info-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            max-width: 250px;
            z-index: 999;
            backdrop-filter: blur(10px);
        }

        .info-panel h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .info-panel div {
            margin: 5px 0;
            color: #666;
        }

        .tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 6px;
            pointer-events: none;
            font-size: 11px;
            z-index: 1001;
            display: none;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 999;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .stats div {
            margin: 5px 0;
            color: #666;
        }

        /* Mermaid „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ */
        .nodeLabel {
            font-family: 'Segoe UI', 'Hiragino Sans', sans-serif !important;
            font-size: 12px !important;
            font-weight: 500 !important;
        }

        .edgeLabel {
            font-family: 'Segoe UI', 'Hiragino Sans', sans-serif !important;
            font-size: 10px !important;
            font-weight: 500 !important;
        }

        /* „Éé„Éº„Éâ„Çπ„Çø„Ç§„É´Âº∑Âåñ */
        .node rect, .node circle, .node ellipse, .node polygon, .node path {
            stroke-width: 2px;
            transition: all 0.3s ease;
        }

        .node:hover rect, .node:hover circle, .node:hover ellipse, 
        .node:hover polygon, .node:hover path {
            stroke-width: 3px;
            filter: brightness(1.05) drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
            cursor: pointer;
        }

        .node.selected rect, .node.selected circle, .node.selected ellipse,
        .node.selected polygon, .node.selected path {
            stroke: #FF5722 !important;
            stroke-width: 4px !important;
            filter: brightness(1.1) drop-shadow(0 0 12px rgba(255, 87, 34, 0.4));
        }

        /* „Ç®„ÉÉ„Ç∏„Çπ„Çø„Ç§„É´ */
        .edgePath path {
            stroke-width: 2px;
            transition: all 0.3s ease;
        }

        .edgePath:hover path {
            stroke-width: 3px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        /* „Éï„É´„Çπ„ÇØ„É™„Éº„É≥„Éú„Çø„É≥ */
        .fullscreen-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1002;
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        /* „Ç®„É©„ÉºË°®Á§∫ */
        .error-message {
            text-align: center;
            padding: 50px;
            color: #d32f2f;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            margin: 20px;
        }

        .error-message h2 {
            color: #d32f2f;
            margin-bottom: 20px;
        }

        .error-message button {
            padding: 10px 20px;
            margin-top: 20px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
            }
            
            .controls {
                gap: 5px;
            }
            
            .controls button, .controls select {
                padding: 5px 8px;
                font-size: 10px;
            }
            
            .flowchart-container {
                top: 70px;
                padding: 10px;
            }
            
            .info-panel {
                top: 80px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .stats {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üìà „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà</h2>
            <div class="controls">
                <button onclick="resetView()" title="Ë°®Á§∫„Çí„É™„Çª„ÉÉ„Éà">üéØ „É™„Çª„ÉÉ„Éà</button>
                <button onclick="zoomIn()" title="Êã°Â§ß">üîç+ Êã°Â§ß</button>
                <button onclick="zoomOut()" title="Á∏ÆÂ∞è">üîç- Á∏ÆÂ∞è</button>
                <select id="themeSelect" onchange="changeTheme()" title="„ÉÜ„Éº„Éû„ÇíÈÅ∏Êäû">
                    <option value="default">„Éá„Éï„Ç©„É´„Éà</option>
                    <option value="dark">„ÉÄ„Éº„ÇØ</option>
                    <option value="forest">„Éï„Ç©„É¨„Çπ„Éà</option>
                    <option value="base">„Éô„Éº„Çπ</option>
                    <option value="neutral">„Éã„É•„Éº„Éà„É©„É´</option>
                </select>
                <button onclick="validateFlow()" title="„Éï„É≠„Éº„ÅÆÊ§úË®º">‚úÖ Ê§úË®º</button>
                <button onclick="exportDiagram()" title="SVG„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">üíæ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                <button onclick="showSource()" title="„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÇíË°®Á§∫">üìù „ÇΩ„Éº„ÇπË°®Á§∫</button>
                <button onclick="optimizeLayout()" title="„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÊúÄÈÅ©Âåñ">üé® ÊúÄÈÅ©Âåñ</button>
            </div>
        </div>

        <div class="flowchart-container">
            <div class="mermaid-wrapper">
                <button class="fullscreen-btn" onclick="toggleFullscreen()" title="„Éï„É´„Çπ„ÇØ„É™„Éº„É≥Âàá„ÇäÊõø„Åà">‚õ∂</button>
                <div id="flowchart">
                    <div class="mermaid" id="mermaidDiagram">
                        {{DIAGRAM_DATA}}
                    </div>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <h4>üìä „Éï„É≠„Éº„ÉÅ„É£„Éº„ÉàÊÉÖÂ†±</h4>
            <div>„Éé„Éº„ÉâÊï∞: <span id="nodeCount">-</span></div>
            <div>„Ç®„ÉÉ„Ç∏Êï∞: <span id="edgeCount">-</span></div>
            <div>„É¨„Éô„É´Êï∞: <span id="levelCount">-</span></div>
            <div>„ÉÜ„Éº„Éû: <span id="currentTheme">„Éá„Éï„Ç©„É´„Éà</span></div>
            <div>„Ç∫„Éº„É†: <span id="zoomLevel">100%</span></div>
        </div>

        <div class="stats">
            <h4>üîß Êìç‰ΩúÊñπÊ≥ï</h4>
            <div>‚Ä¢ „Éû„Ç¶„Çπ„Éâ„É©„ÉÉ„Ç∞„Åß„Éë„É≥ÁßªÂãï</div>
            <div>‚Ä¢ „Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´„Åß„Ç∫„Éº„É†</div>
            <div>‚Ä¢ „Éé„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈÅ∏Êäû„ÉªË©≥Á¥∞</div>
            <div>‚Ä¢ R„Ç≠„Éº„Åß„É™„Çª„ÉÉ„ÉàË°®Á§∫</div>
            <div>‚Ä¢ Ctrl +/- „Åß„Ç∫„Éº„É†Ë™øÊï¥</div>
        </div>

        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // „Éá„Éº„Çø„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÔºàÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„Å´ÁΩÆ„ÅçÊèõ„Åà„Çâ„Çå„Åæ„ÅôÔºâ
        let flowchartData = `{{DIAGRAM_DATA}}`;
        
        // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Çµ„É≥„Éó„É´„Éá„Éº„Çø
        if (!flowchartData || flowchartData === '{{DIAGRAM_DATA}}') {
            flowchartData = `flowchart TD
    A[ÈñãÂßã] --> B{Êù°‰ª∂Âà§ÂÆö}
    B -->|Yes| C[Âá¶ÁêÜAÂÆüË°å]
    B -->|No| D[Âá¶ÁêÜBÂÆüË°å]
    C --> E[ÁµêÊûúÂá∫Âäõ]
    D --> E
    E --> F{Á∂öË°åÔºü}
    F -->|Yes| G[ËøΩÂä†Âá¶ÁêÜ]
    F -->|No| H[ÁµÇ‰∫Ü]
    G --> H`;
        }

        // MermaidË®≠ÂÆö
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                fontFamily: 'Segoe UI, Hiragino Sans, Yu Gothic UI, sans-serif',
                fontSize: '12px',
                primaryColor: '#4CAF50',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2E7D32',
                lineColor: '#666',
                secondaryColor: '#2196F3',
                tertiaryColor: '#FFC107',
                background: '#ffffff',
                mainBkg: '#4CAF50',
                secondBkg: '#2196F3',
                tertiaryColor: '#FFC107'
            },
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            },
            securityLevel: 'loose'
        });

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentZoom = 1;
        let panX = 0, panY = 0;
        let isDragging = false;
        let startX, startY;
        let selectedNode = null;
        let currentTheme = 'default';

        // ÂàùÊúüÂåñ
        initializeFlowchart();

        async function initializeFlowchart() {
            try {
                const element = document.getElementById('mermaidDiagram');
                
                // Mermaid„Åß„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                const { svg } = await mermaid.render('graphDiv', flowchartData);
                element.innerHTML = svg;
                
                // „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñÊ©üËÉΩ„ÇíË®≠ÂÆö
                setupInteractivity();
                updateStats();
                
                console.log('‚úÖ „Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅÆÂàùÊúüÂåñÂÆå‰∫Ü');
                
            } catch (error) {
                console.error('Mermaid rendering error:', error);
                showError('„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅÆÊèèÁîª„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        function setupInteractivity() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) return;

            // SVG„Çµ„Ç§„Ç∫„ÇíË™øÊï¥
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.maxWidth = 'none';
            svg.style.maxHeight = 'none';

            // „Ç∫„Éº„É†„Éª„Éë„É≥Ê©üËÉΩ„ÇíË®≠ÂÆö
            setupZoomPan(svg);

            // „Éé„Éº„Éâ„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥Ë®≠ÂÆö
            setupNodeInteractions(svg);

            // „Ç®„ÉÉ„Ç∏„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥Ë®≠ÂÆö
            setupEdgeInteractions(svg);
        }

        function setupZoomPan(svg) {
            // „Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´„Ç§„Éô„É≥„Éà
            svg.addEventListener('wheel', handleWheel);
            
            // „Éû„Ç¶„Çπ„Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„Éà
            svg.addEventListener('mousedown', handleMouseDown);
            svg.addEventListener('mousemove', handleMouseMove);
            svg.addEventListener('mouseup', handleMouseUp);
            svg.addEventListener('mouseleave', handleMouseUp);

            // ÂàùÊúüÂ§âÊèõ„ÇíÈÅ©Áî®
            applyTransform();
        }

        function setupNodeInteractions(svg) {
            const nodes = svg.querySelectorAll('.node');
            nodes.forEach((node, index) => {
                node.addEventListener('click', (e) => handleNodeClick(e, node));
                node.addEventListener('mouseenter', (e) => showNodeTooltip(e, node));
                node.addEventListener('mouseleave', hideTooltip);
                
                // „Éé„Éº„Éâ„Å´ID„ÇíË®≠ÂÆö
                if (!node.id) {
                    node.id = `node-${index}`;
                }
            });
        }

        function setupEdgeInteractions(svg) {
            const edges = svg.querySelectorAll('.edgePath');
            edges.forEach(edge => {
                edge.addEventListener('mouseenter', (e) => showEdgeTooltip(e, edge));
                edge.addEventListener('mouseleave', hideTooltip);
            });
        }

        // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            currentZoom = Math.max(0.1, Math.min(3, currentZoom * delta));
            applyTransform();
            updateZoomDisplay();
        }

        function handleMouseDown(e) {
            if (e.target.closest('.node')) return; // „Éé„Éº„Éâ‰∏ä„Åß„ÅØÁÑ°Âäπ
            
            isDragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
            document.querySelector('#flowchart').style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!isDragging) return;
            panX = e.clientX - startX;
            panY = e.clientY - startY;
            applyTransform();
        }

        function handleMouseUp(e) {
            isDragging = false;
            document.querySelector('#flowchart').style.cursor = 'grab';
        }

        function applyTransform() {
            const svg = document.querySelector('#flowchart svg');
            if (svg) {
                svg.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
                svg.style.transformOrigin = 'center center';
            }
        }

        function updateZoomDisplay() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        // „Éé„Éº„ÉâÊìç‰Ωú
        function handleNodeClick(e, node) {
            e.stopPropagation();
            
            // Êó¢Â≠òÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            document.querySelectorAll('.node').forEach(n => {
                n.classList.remove('selected');
            });

            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            node.classList.add('selected');
            selectedNode = node;

            // „Éé„Éº„ÉâË©≥Á¥∞„ÇíË°®Á§∫
            showNodeDetails(node);
        }

        function showNodeDetails(node) {
            const nodeText = getNodeText(node);
            const nodeType = getNodeType(node);
            
            const details = `
„Éé„Éº„ÉâË©≥Á¥∞ÊÉÖÂ†±:
ÂêçÂâç: ${nodeText}
„Çø„Ç§„Éó: ${nodeType}
ID: ${node.id || 'N/A'}

„Åì„ÅÆ„Éé„Éº„Éâ„Çí„Éè„Ç§„É©„Ç§„Éà„Åó„Åæ„Åó„Åü„ÄÇ
            `;
            
            // Á∞°ÊòìË°®Á§∫ÔºàÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Åß„ÅØ„É¢„Éº„ÉÄ„É´„ÇÑ„Çµ„Ç§„Éâ„Éë„Éç„É´„Çí‰ΩøÁî®Ôºâ
            console.log('ÈÅ∏Êäû„Åï„Çå„Åü„Éé„Éº„Éâ:', nodeText, nodeType);
            
            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅßË©≥Á¥∞Ë°®Á§∫
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>${nodeText}</strong><br>
                „Çø„Ç§„Éó: ${nodeType}<br>
                ID: ${node.id || 'N/A'}<br>
                <small>ÈÅ∏Êäû‰∏≠...</small>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = '50%';
            tooltip.style.top = '20px';
            tooltip.style.transform = 'translateX(-50%)';
            
            setTimeout(() => {
                tooltip.style.display = 'none';
            }, 3000);
        }

        function getNodeText(node) {
            const textElement = node.querySelector('foreignObject, .nodeLabel, text');
            return textElement ? textElement.textContent.trim() : 'Unknown Node';
        }

        function getNodeType(node) {
            const shape = node.querySelector('rect, circle, polygon, ellipse, path');
            if (!shape) return '„ÉÜ„Ç≠„Çπ„Éà';
            
            const tagName = shape.tagName.toLowerCase();
            switch(tagName) {
                case 'rect': return 'Áü©ÂΩ¢';
                case 'circle': return 'ÂÜÜ';
                case 'ellipse': return 'Ê•ïÂÜÜ';
                case 'polygon': return 'Â§öËßíÂΩ¢';
                case 'path': return '„Ç´„Çπ„Çø„É†ÂΩ¢Áä∂';
                default: return '‰∏çÊòé';
            }
        }

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÊ©üËÉΩ
        function showNodeTooltip(e, node) {
            const tooltip = document.getElementById('tooltip');
            const nodeText = getNodeText(node);
            const nodeType = getNodeType(node);
            
            tooltip.innerHTML = `
                <strong>${nodeText}</strong><br>
                „Çø„Ç§„Éó: ${nodeType}<br>
                <small>„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞Ë°®Á§∫</small>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY - 10) + 'px';
            tooltip.style.transform = 'none';
        }

        function showEdgeTooltip(e, edge) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>Êé•Á∂öÁ∑ö</strong><br>
                <small>„Éé„Éº„ÉâÈñì„ÅÆÈñ¢‰øÇ„ÇíË°®Á§∫</small>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY - 10) + 'px';
            tooltip.style.transform = 'none';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
        function updateStats() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) return;

            const nodeCount = svg.querySelectorAll('.node').length;
            const edgeCount = svg.querySelectorAll('.edgePath').length;
            const levelCount = calculateLevels();
            
            document.getElementById('nodeCount').textContent = nodeCount;
            document.getElementById('edgeCount').textContent = edgeCount;
            document.getElementById('levelCount').textContent = levelCount;
            
            console.log(`Áµ±Ë®à: „Éé„Éº„Éâ${nodeCount}ÂÄã, „Ç®„ÉÉ„Ç∏${edgeCount}ÂÄã, „É¨„Éô„É´${levelCount}`);
        }

        function calculateLevels() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) return 0;

            const nodes = Array.from(svg.querySelectorAll('.node'));
            if (nodes.length === 0) return 0;

            // „Éé„Éº„Éâ„ÅÆY‰ΩçÁΩÆ„ÇíÂèñÂæó„Åó„Å¶„É¨„Éô„É´Êï∞„ÇíË®àÁÆó
            const yPositions = nodes.map(node => {
                const transform = node.getAttribute('transform');
                const match = transform ? transform.match(/translate\\(([\\d.-]+),([\\d.-]+)\\)/) : null;
                return match ? parseFloat(match[2]) : 0;
            });

            const uniqueY = [...new Set(yPositions.map(y => Math.round(y / 50)))];
            return Math.max(1, uniqueY.length);
        }

        // „Ç≥„É≥„Éà„É≠„Éº„É´Èñ¢Êï∞
        function resetView() {
            currentZoom = 1;
            panX = 0;
            panY = 0;
            applyTransform();
            updateZoomDisplay();
            
            // ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            document.querySelectorAll('.node').forEach(n => {
                n.classList.remove('selected');
            });
            selectedNode = null;
        }

        function zoomIn() {
            currentZoom = Math.min(3, currentZoom * 1.2);
            applyTransform();
            updateZoomDisplay();
        }

        function zoomOut() {
            currentZoom = Math.max(0.1, currentZoom * 0.8);
            applyTransform();
            updateZoomDisplay();
        }

        function changeTheme() {
            const theme = document.getElementById('themeSelect').value;
            currentTheme = theme;
            
            const themeNames = {
                'default': '„Éá„Éï„Ç©„É´„Éà',
                'dark': '„ÉÄ„Éº„ÇØ',
                'forest': '„Éï„Ç©„É¨„Çπ„Éà',
                'base': '„Éô„Éº„Çπ',
                'neutral': '„Éã„É•„Éº„Éà„É©„É´'
            };
            
            document.getElementById('currentTheme').textContent = themeNames[theme];

            // Mermaid„ÉÜ„Éº„Éû„ÇíÂ§âÊõ¥„Åó„Å¶ÂÜçÊèèÁîª
            mermaid.initialize({ theme: theme });
            initializeFlowchart();
        }

        function validateFlow() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) {
                alert('‚ùå „Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            const nodeCount = svg.querySelectorAll('.node').length;
            const edgeCount = svg.querySelectorAll('.edgePath').length;
            
            const issues = [];
            
            if (nodeCount === 0) {
                issues.push('„Éé„Éº„Éâ„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì');
            }
            
            if (nodeCount > 0 && edgeCount === 0) {
                issues.push('Êé•Á∂öÁ∑ö„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„ÇìÔºàÂçòÁã¨„Éé„Éº„ÉâÔºâ');
            }
            
            const isValid = issues.length === 0;
            const message = isValid ? 
                `‚úÖ „Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅØÊúâÂäπ„Åß„Åô\\n\\nÁµ±Ë®à:\\n‚Ä¢ „Éé„Éº„Éâ: ${nodeCount}ÂÄã\\n‚Ä¢ „Ç®„ÉÉ„Ç∏: ${edgeCount}ÂÄã\\n‚Ä¢ „É¨„Éô„É´: ${calculateLevels()}Â±§` :
                `‚ö†Ô∏è ‰ª•‰∏ã„ÅÆÂïèÈ°å„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü:\\n\\n${issues.join('\\n')}`;
                
            alert(message);
        }

        function exportDiagram() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) {
                alert('‚ùå „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            try {
                // SVG„Çí‰∏ÄÊôÇÁöÑ„Å´Ê≠£Ë¶èÂåñ
                const clonedSvg = svg.cloneNode(true);
                clonedSvg.style.transform = 'none';
                clonedSvg.setAttribute('width', svg.getBoundingClientRect().width);
                clonedSvg.setAttribute('height', svg.getBoundingClientRect().height);
                
                const svgData = new XMLSerializer().serializeToString(clonedSvg);
                const blob = new Blob([svgData], {type: "image/svg+xml"});
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "flowchart.svg";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ SVG„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂÆå‰∫Ü');
            } catch (error) {
                alert('‚ùå „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        function showSource() {
            const source = flowchartData.trim();
            const popup = window.open('', '_blank', 'width=700,height=500,scrollbars=yes,resizable=yes');
            popup.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mermaid „ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ</title>
                    <style>
                        body { 
                            font-family: 'Consolas', 'Monaco', monospace; 
                            padding: 20px; 
                            line-height: 1.6;
                            background: #f5f5f5;
                        }
                        .container {
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        pre { 
                            background: #f8f8f8; 
                            padding: 15px; 
                            border-radius: 5px; 
                            border-left: 4px solid #4CAF50;
                            overflow-x: auto;
                            font-size: 14px;
                        }
                        .copy-btn {
                            margin-top: 10px;
                            padding: 8px 16px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h2>üìù Mermaid „ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ</h2>
                        <pre id="sourceCode">${source}</pre>
                        <button class="copy-btn" onclick="copyToClipboard()">üìã „Ç≥„Éî„Éº</button>
                    </div>
                    <script>
                        function copyToClipboard() {
                            const code = document.getElementById('sourceCode').textContent;
                            navigator.clipboard.writeText(code).then(() => {
                                alert('‚úÖ „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
                            });
                        }
                    </script>
                </body>
                </html>
            `);
        }

        function optimizeLayout() {
            // „É¨„Ç§„Ç¢„Ç¶„ÉàÊúÄÈÅ©ÂåñÔºàÂÜçÊèèÁîªÔºâ
            console.log('üé® „É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÊúÄÈÅ©Âåñ‰∏≠...');
            initializeFlowchart();
            resetView();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showError(message) {
            const container = document.getElementById('flowchart');
            container.innerHTML = `
                <div class="error-message">
                    <h2>‚ö†Ô∏è „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h2>
                    <p>${message}</p>
                    <button onclick="location.reload()">üîÑ ÂÜçË™≠„ÅøËæº„Åø</button>
                </div>
            `;
        }

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.code) {
                case 'KeyR':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        resetView();
                    }
                    break;
                case 'Equal': // +
                case 'NumpadAdd':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        zoomIn();
                    }
                    break;
                case 'Minus': // -
                case 'NumpadSubtract':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        zoomOut();
                    }
                    break;
                case 'Escape':
                    // ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
                    document.querySelectorAll('.node').forEach(n => {
                        n.classList.remove('selected');
                    });
                    selectedNode = null;
                    hideTooltip();
                    break;
            }
        });

        // „É™„Çµ„Ç§„Ç∫ÂØæÂøú
        window.addEventListener('resize', () => {
            setTimeout(() => {
                const svg = document.querySelector('#flowchart svg');
                if (svg) {
                    // SVG„Çµ„Ç§„Ç∫„ÇíÂÜçË™øÊï¥
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                }
            }, 100);
        });

        // „Éï„É´„Çπ„ÇØ„É™„Éº„É≥Â§âÊõ¥„ÅÆÁõ£Ë¶ñ
        document.addEventListener('fullscreenchange', () => {
            setTimeout(() => {
                const svg = document.querySelector('#flowchart svg');
                if (svg) {
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                }
            }, 100);
        });

        // ÂàùÊúüË°®Á§∫„É°„ÉÉ„Çª„Éº„Ç∏
        console.log('üìà „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà„ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü');
        console.log('„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà: R(„É™„Çª„ÉÉ„Éà), Ctrl +/-(„Ç∫„Éº„É†), Esc(ÈÅ∏ÊäûËß£Èô§)');
    </script>
</body>
</html>