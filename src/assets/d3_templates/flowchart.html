<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ - D3-Mind-Flow-Editor</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h2 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .controls button, .controls select {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .controls button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .controls select {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .flowchart-container {
            position: absolute;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 20px;
            overflow: hidden;
        }

        .mermaid-wrapper {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
        }

        #flowchart {
            width: 100%;
            height: 100%;
            text-align: center;
            overflow: auto;
            cursor: grab;
        }

        #flowchart:active {
            cursor: grabbing;
        }

        .mermaid {
            background: transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .info-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            max-width: 250px;
            z-index: 999;
            backdrop-filter: blur(10px);
        }

        .info-panel h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .info-panel div {
            margin: 5px 0;
            color: #666;
        }

        .tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 6px;
            pointer-events: none;
            font-size: 11px;
            z-index: 1001;
            display: none;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 999;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .stats div {
            margin: 5px 0;
            color: #666;
        }

        /* Mermaid ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .nodeLabel {
            font-family: 'Segoe UI', 'Hiragino Sans', sans-serif !important;
            font-size: 12px !important;
            font-weight: 500 !important;
        }

        .edgeLabel {
            font-family: 'Segoe UI', 'Hiragino Sans', sans-serif !important;
            font-size: 10px !important;
            font-weight: 500 !important;
        }

        /* ãƒãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ– */
        .node rect, .node circle, .node ellipse, .node polygon, .node path {
            stroke-width: 2px;
            transition: all 0.3s ease;
        }

        .node:hover rect, .node:hover circle, .node:hover ellipse, 
        .node:hover polygon, .node:hover path {
            stroke-width: 3px;
            filter: brightness(1.05) drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
            cursor: pointer;
        }

        .node.selected rect, .node.selected circle, .node.selected ellipse,
        .node.selected polygon, .node.selected path {
            stroke: #FF5722 !important;
            stroke-width: 4px !important;
            filter: brightness(1.1) drop-shadow(0 0 12px rgba(255, 87, 34, 0.4));
        }

        /* ã‚¨ãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
        .edgePath path {
            stroke-width: 2px;
            transition: all 0.3s ease;
        }

        .edgePath:hover path {
            stroke-width: 3px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³ */
        .fullscreen-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1002;
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
        .error-message {
            text-align: center;
            padding: 50px;
            color: #d32f2f;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            margin: 20px;
        }

        .error-message h2 {
            color: #d32f2f;
            margin-bottom: 20px;
        }

        .error-message button {
            padding: 10px 20px;
            margin-top: 20px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
            }
            
            .controls {
                gap: 5px;
            }
            
            .controls button, .controls select {
                padding: 5px 8px;
                font-size: 10px;
            }
            
            .flowchart-container {
                top: 70px;
                padding: 10px;
            }
            
            .info-panel {
                top: 80px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .stats {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ğŸ“ˆ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</h2>
            <div class="controls">
                <button onclick="resetView()" title="è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ">ğŸ¯ ãƒªã‚»ãƒƒãƒˆ</button>
                <button onclick="zoomIn()" title="æ‹¡å¤§">ğŸ”+ æ‹¡å¤§</button>
                <button onclick="zoomOut()" title="ç¸®å°">ğŸ”- ç¸®å°</button>
                <select id="themeSelect" onchange="changeTheme()" title="ãƒ†ãƒ¼ãƒã‚’é¸æŠ">
                    <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                    <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
                    <option value="forest">ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ</option>
                    <option value="base">ãƒ™ãƒ¼ã‚¹</option>
                    <option value="neutral">ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«</option>
                </select>
                <button onclick="validateFlow()" title="ãƒ•ãƒ­ãƒ¼ã®æ¤œè¨¼">âœ… æ¤œè¨¼</button>
                <button onclick="exportDiagram()" title="SVGã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">ğŸ’¾ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button onclick="showSource()" title="ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º">ğŸ“ ã‚½ãƒ¼ã‚¹è¡¨ç¤º</button>
                <button onclick="optimizeLayout()" title="ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æœ€é©åŒ–">ğŸ¨ æœ€é©åŒ–</button>
            </div>
        </div>

        <div class="flowchart-container">
            <div class="mermaid-wrapper">
                <button class="fullscreen-btn" onclick="toggleFullscreen()" title="ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆ">â›¶</button>
                <div id="flowchart">
                    <div class="mermaid" id="mermaidDiagram">
                        {{DIAGRAM_DATA}}
                    </div>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <h4>ğŸ“Š ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæƒ…å ±</h4>
            <div>ãƒãƒ¼ãƒ‰æ•°: <span id="nodeCount">-</span></div>
            <div>ã‚¨ãƒƒã‚¸æ•°: <span id="edgeCount">-</span></div>
            <div>ãƒ¬ãƒ™ãƒ«æ•°: <span id="levelCount">-</span></div>
            <div>ãƒ†ãƒ¼ãƒ: <span id="currentTheme">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span></div>
            <div>ã‚ºãƒ¼ãƒ : <span id="zoomLevel">100%</span></div>
        </div>

        <div class="stats">
            <h4>ğŸ”§ æ“ä½œæ–¹æ³•</h4>
            <div>â€¢ ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³ç§»å‹•</div>
            <div>â€¢ ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ </div>
            <div>â€¢ ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠãƒ»è©³ç´°</div>
            <div>â€¢ Rã‚­ãƒ¼ã§ãƒªã‚»ãƒƒãƒˆè¡¨ç¤º</div>
            <div>â€¢ Ctrl +/- ã§ã‚ºãƒ¼ãƒ èª¿æ•´</div>
        </div>

        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ï¼‰
        let flowchartData = `{{DIAGRAM_DATA}}`;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        if (!flowchartData || flowchartData === '{{DIAGRAM_DATA}}') {
            flowchartData = `flowchart TD
    A[é–‹å§‹] --> B{æ¡ä»¶åˆ¤å®š}
    B -->|Yes| C[å‡¦ç†Aå®Ÿè¡Œ]
    B -->|No| D[å‡¦ç†Bå®Ÿè¡Œ]
    C --> E[çµæœå‡ºåŠ›]
    D --> E
    E --> F{ç¶šè¡Œï¼Ÿ}
    F -->|Yes| G[è¿½åŠ å‡¦ç†]
    F -->|No| H[çµ‚äº†]
    G --> H`;
        }

        // Mermaidè¨­å®š
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                fontFamily: 'Segoe UI, Hiragino Sans, Yu Gothic UI, sans-serif',
                fontSize: '12px',
                primaryColor: '#4CAF50',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2E7D32',
                lineColor: '#666',
                secondaryColor: '#2196F3',
                tertiaryColor: '#FFC107',
                background: '#ffffff',
                mainBkg: '#4CAF50',
                secondBkg: '#2196F3',
                tertiaryColor: '#FFC107'
            },
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            },
            securityLevel: 'loose'
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentZoom = 1;
        let panX = 0, panY = 0;
        let isDragging = false;
        let startX, startY;
        let selectedNode = null;
        let currentTheme = 'default';

        // åˆæœŸåŒ–
        initializeFlowchart();

        async function initializeFlowchart() {
            try {
                const element = document.getElementById('mermaidDiagram');
                
                // Mermaidã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                const { svg } = await mermaid.render('graphDiv', flowchartData);
                element.innerHTML = svg;
                
                // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ©Ÿèƒ½ã‚’è¨­å®š
                setupInteractivity();
                updateStats();
                
                console.log('âœ… ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('Mermaid rendering error:', error);
                showError('ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®æç”»ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function setupInteractivity() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) return;

            // SVGã‚µã‚¤ã‚ºã‚’èª¿æ•´
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.maxWidth = 'none';
            svg.style.maxHeight = 'none';

            // ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ©Ÿèƒ½ã‚’è¨­å®š
            setupZoomPan(svg);

            // ãƒãƒ¼ãƒ‰ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
            setupNodeInteractions(svg);

            // ã‚¨ãƒƒã‚¸ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
            setupEdgeInteractions(svg);
        }

        function setupZoomPan(svg) {
            // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
            svg.addEventListener('wheel', handleWheel);
            
            // ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
            svg.addEventListener('mousedown', handleMouseDown);
            svg.addEventListener('mousemove', handleMouseMove);
            svg.addEventListener('mouseup', handleMouseUp);
            svg.addEventListener('mouseleave', handleMouseUp);

            // åˆæœŸå¤‰æ›ã‚’é©ç”¨
            applyTransform();
        }

        function setupNodeInteractions(svg) {
            const nodes = svg.querySelectorAll('.node');
            nodes.forEach((node, index) => {
                node.addEventListener('click', (e) => handleNodeClick(e, node));
                node.addEventListener('mouseenter', (e) => showNodeTooltip(e, node));
                node.addEventListener('mouseleave', hideTooltip);
                
                // ãƒãƒ¼ãƒ‰ã«IDã‚’è¨­å®š
                if (!node.id) {
                    node.id = `node-${index}`;
                }
            });
        }

        function setupEdgeInteractions(svg) {
            const edges = svg.querySelectorAll('.edgePath');
            edges.forEach(edge => {
                edge.addEventListener('mouseenter', (e) => showEdgeTooltip(e, edge));
                edge.addEventListener('mouseleave', hideTooltip);
            });
        }

        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            currentZoom = Math.max(0.1, Math.min(3, currentZoom * delta));
            applyTransform();
            updateZoomDisplay();
        }

        function handleMouseDown(e) {
            if (e.target.closest('.node')) return; // ãƒãƒ¼ãƒ‰ä¸Šã§ã¯ç„¡åŠ¹
            
            isDragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
            document.querySelector('#flowchart').style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!isDragging) return;
            panX = e.clientX - startX;
            panY = e.clientY - startY;
            applyTransform();
        }

        function handleMouseUp(e) {
            isDragging = false;
            document.querySelector('#flowchart').style.cursor = 'grab';
        }

        function applyTransform() {
            const svg = document.querySelector('#flowchart svg');
            if (svg) {
                svg.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
                svg.style.transformOrigin = 'center center';
            }
        }

        function updateZoomDisplay() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        // ãƒãƒ¼ãƒ‰æ“ä½œ
        function handleNodeClick(e, node) {
            e.stopPropagation();
            
            // æ—¢å­˜é¸æŠã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.node').forEach(n => {
                n.classList.remove('selected');
            });

            // æ–°ã—ã„é¸æŠ
            node.classList.add('selected');
            selectedNode = node;

            // ãƒãƒ¼ãƒ‰è©³ç´°ã‚’è¡¨ç¤º
            showNodeDetails(node);
        }

        function showNodeDetails(node) {
            const nodeText = getNodeText(node);
            const nodeType = getNodeType(node);
            
            const details = `
ãƒãƒ¼ãƒ‰è©³ç´°æƒ…å ±:
åå‰: ${nodeText}
ã‚¿ã‚¤ãƒ—: ${nodeType}
ID: ${node.id || 'N/A'}

ã“ã®ãƒãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¾ã—ãŸã€‚
            `;
            
            // ç°¡æ˜“è¡¨ç¤ºï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚„ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’ä½¿ç”¨ï¼‰
            console.log('é¸æŠã•ã‚ŒãŸãƒãƒ¼ãƒ‰:', nodeText, nodeType);
            
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>${nodeText}</strong><br>
                ã‚¿ã‚¤ãƒ—: ${nodeType}<br>
                ID: ${node.id || 'N/A'}<br>
                <small>é¸æŠä¸­...</small>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = '50%';
            tooltip.style.top = '20px';
            tooltip.style.transform = 'translateX(-50%)';
            
            setTimeout(() => {
                tooltip.style.display = 'none';
            }, 3000);
        }

        function getNodeText(node) {
            const textElement = node.querySelector('foreignObject, .nodeLabel, text');
            return textElement ? textElement.textContent.trim() : 'Unknown Node';
        }

        function getNodeType(node) {
            const shape = node.querySelector('rect, circle, polygon, ellipse, path');
            if (!shape) return 'ãƒ†ã‚­ã‚¹ãƒˆ';
            
            const tagName = shape.tagName.toLowerCase();
            switch(tagName) {
                case 'rect': return 'çŸ©å½¢';
                case 'circle': return 'å††';
                case 'ellipse': return 'æ¥•å††';
                case 'polygon': return 'å¤šè§’å½¢';
                case 'path': return 'ã‚«ã‚¹ã‚¿ãƒ å½¢çŠ¶';
                default: return 'ä¸æ˜';
            }
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ©Ÿèƒ½
        function showNodeTooltip(e, node) {
            const tooltip = document.getElementById('tooltip');
            const nodeText = getNodeText(node);
            const nodeType = getNodeType(node);
            
            tooltip.innerHTML = `
                <strong>${nodeText}</strong><br>
                ã‚¿ã‚¤ãƒ—: ${nodeType}<br>
                <small>ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º</small>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY - 10) + 'px';
            tooltip.style.transform = 'none';
        }

        function showEdgeTooltip(e, edge) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>æ¥ç¶šç·š</strong><br>
                <small>ãƒãƒ¼ãƒ‰é–“ã®é–¢ä¿‚ã‚’è¡¨ç¤º</small>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY - 10) + 'px';
            tooltip.style.transform = 'none';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        function updateStats() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) return;

            const nodeCount = svg.querySelectorAll('.node').length;
            const edgeCount = svg.querySelectorAll('.edgePath').length;
            const levelCount = calculateLevels();
            
            document.getElementById('nodeCount').textContent = nodeCount;
            document.getElementById('edgeCount').textContent = edgeCount;
            document.getElementById('levelCount').textContent = levelCount;
            
            console.log(`çµ±è¨ˆ: ãƒãƒ¼ãƒ‰${nodeCount}å€‹, ã‚¨ãƒƒã‚¸${edgeCount}å€‹, ãƒ¬ãƒ™ãƒ«${levelCount}`);
        }

        function calculateLevels() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) return 0;

            const nodes = Array.from(svg.querySelectorAll('.node'));
            if (nodes.length === 0) return 0;

            // ãƒãƒ¼ãƒ‰ã®Yä½ç½®ã‚’å–å¾—ã—ã¦ãƒ¬ãƒ™ãƒ«æ•°ã‚’è¨ˆç®—
            const yPositions = nodes.map(node => {
                const transform = node.getAttribute('transform');
                const match = transform ? transform.match(/translate\\(([\\d.-]+),([\\d.-]+)\\)/) : null;
                return match ? parseFloat(match[2]) : 0;
            });

            const uniqueY = [...new Set(yPositions.map(y => Math.round(y / 50)))];
            return Math.max(1, uniqueY.length);
        }

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é–¢æ•°
        function resetView() {
            currentZoom = 1;
            panX = 0;
            panY = 0;
            applyTransform();
            updateZoomDisplay();
            
            // é¸æŠã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.node').forEach(n => {
                n.classList.remove('selected');
            });
            selectedNode = null;
        }

        function zoomIn() {
            currentZoom = Math.min(3, currentZoom * 1.2);
            applyTransform();
            updateZoomDisplay();
        }

        function zoomOut() {
            currentZoom = Math.max(0.1, currentZoom * 0.8);
            applyTransform();
            updateZoomDisplay();
        }

        function changeTheme() {
            const theme = document.getElementById('themeSelect').value;
            currentTheme = theme;
            
            const themeNames = {
                'default': 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',
                'dark': 'ãƒ€ãƒ¼ã‚¯',
                'forest': 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ',
                'base': 'ãƒ™ãƒ¼ã‚¹',
                'neutral': 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«'
            };
            
            document.getElementById('currentTheme').textContent = themeNames[theme];

            // Mermaidãƒ†ãƒ¼ãƒã‚’å¤‰æ›´ã—ã¦å†æç”»
            mermaid.initialize({ theme: theme });
            initializeFlowchart();
        }

        function validateFlow() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) {
                alert('âŒ ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const nodeCount = svg.querySelectorAll('.node').length;
            const edgeCount = svg.querySelectorAll('.edgePath').length;
            
            const issues = [];
            
            if (nodeCount === 0) {
                issues.push('ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            }
            
            if (nodeCount > 0 && edgeCount === 0) {
                issues.push('æ¥ç¶šç·šãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆå˜ç‹¬ãƒãƒ¼ãƒ‰ï¼‰');
            }
            
            const isValid = issues.length === 0;
            const message = isValid ? 
                `âœ… ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã¯æœ‰åŠ¹ã§ã™\\n\\nçµ±è¨ˆ:\\nâ€¢ ãƒãƒ¼ãƒ‰: ${nodeCount}å€‹\\nâ€¢ ã‚¨ãƒƒã‚¸: ${edgeCount}å€‹\\nâ€¢ ãƒ¬ãƒ™ãƒ«: ${calculateLevels()}å±¤` :
                `âš ï¸ ä»¥ä¸‹ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\\n\\n${issues.join('\\n')}`;
                
            alert(message);
        }

        function exportDiagram() {
            const svg = document.querySelector('#flowchart svg');
            if (!svg) {
                alert('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                // SVGã‚’ä¸€æ™‚çš„ã«æ­£è¦åŒ–
                const clonedSvg = svg.cloneNode(true);
                clonedSvg.style.transform = 'none';
                clonedSvg.setAttribute('width', svg.getBoundingClientRect().width);
                clonedSvg.setAttribute('height', svg.getBoundingClientRect().height);
                
                const svgData = new XMLSerializer().serializeToString(clonedSvg);
                const blob = new Blob([svgData], {type: "image/svg+xml"});
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "flowchart.svg";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('âœ… SVGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
            } catch (error) {
                alert('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function showSource() {
            const source = flowchartData.trim();
            const popup = window.open('', '_blank', 'width=700,height=500,scrollbars=yes,resizable=yes');
            popup.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mermaid ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</title>
                    <style>
                        body { 
                            font-family: 'Consolas', 'Monaco', monospace; 
                            padding: 20px; 
                            line-height: 1.6;
                            background: #f5f5f5;
                        }
                        .container {
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        pre { 
                            background: #f8f8f8; 
                            padding: 15px; 
                            border-radius: 5px; 
                            border-left: 4px solid #4CAF50;
                            overflow-x: auto;
                            font-size: 14px;
                        }
                        .copy-btn {
                            margin-top: 10px;
                            padding: 8px 16px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h2>ğŸ“ Mermaid ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</h2>
                        <pre id="sourceCode">${source}</pre>
                        <button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <script>
                        function copyToClipboard() {
                            const code = document.getElementById('sourceCode').textContent;
                            navigator.clipboard.writeText(code).then(() => {
                                alert('âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                            });
                        }
                    </script>
                </body>
                </html>
            `);
        }

        function optimizeLayout() {
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ–ï¼ˆå†æç”»ï¼‰
            console.log('ğŸ¨ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æœ€é©åŒ–ä¸­...');
            initializeFlowchart();
            resetView();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showError(message) {
            const container = document.getElementById('flowchart');
            container.innerHTML = `
                <div class="error-message">
                    <h2>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
                    <p>${message}</p>
                    <button onclick="location.reload()">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
                </div>
            `;
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.code) {
                case 'KeyR':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        resetView();
                    }
                    break;
                case 'Equal': // +
                case 'NumpadAdd':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        zoomIn();
                    }
                    break;
                case 'Minus': // -
                case 'NumpadSubtract':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        zoomOut();
                    }
                    break;
                case 'Escape':
                    // é¸æŠã‚’ã‚¯ãƒªã‚¢
                    document.querySelectorAll('.node').forEach(n => {
                        n.classList.remove('selected');
                    });
                    selectedNode = null;
                    hideTooltip();
                    break;
            }
        });

        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
            setTimeout(() => {
                const svg = document.querySelector('#flowchart svg');
                if (svg) {
                    // SVGã‚µã‚¤ã‚ºã‚’å†èª¿æ•´
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                }
            }, 100);
        });

        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å¤‰æ›´ã®ç›£è¦–
        document.addEventListener('fullscreenchange', () => {
            setTimeout(() => {
                const svg = document.querySelector('#flowchart svg');
                if (svg) {
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                }
            }, 100);
        });

        // åˆæœŸè¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        console.log('ğŸ“ˆ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        console.log('ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: R(ãƒªã‚»ãƒƒãƒˆ), Ctrl +/-(ã‚ºãƒ¼ãƒ ), Esc(é¸æŠè§£é™¤)');
    </script>
</body>
</html>